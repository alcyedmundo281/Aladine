<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Generador de Informes CONAMEI Automatizado (Alta Fidelidad)</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <style>
        body { font-family: 'Inter', sans-serif; }
        .loader {
            border: 4px solid #f3f3f3;
            border-top: 4px solid #3498db;
            border-radius: 50%;
            width: 30px;
            height: 30px;
            animation: spin 1s linear infinite;
        }
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        .status-message { transition: opacity 0.5s ease-in-out; }
        #report-frame {
            width: 100%;
            height: 60vh;
            min-height: 500px;
            border: 1px solid #d1d5db;
            border-radius: 0.375rem;
        }
    </style>
</head>
<body class="bg-gray-100 p-4 sm:p-6 md:p-8">
    <div class="max-w-4xl mx-auto bg-white rounded-xl shadow-lg overflow-hidden">
        <div class="bg-gray-800 p-6">
            <h1 class="text-2xl font-bold text-white">Generador de Informes CONAMEI Automatizado</h1>
            <p class="text-gray-300 mt-1">Genera el informe HTML final en un solo clic con máxima fidelidad al formato oficial.</p>
        </div>

        <div class="p-6 md:p-8 space-y-6">
            <!-- API KEY INPUT -->
            <div>
                <label for="apiKey" class="block text-sm font-medium text-gray-700">Tu API Key de Google AI</label>
                <div class="mt-1 flex items-center space-x-2">
                    <input type="password" id="apiKey" class="block w-full rounded-md border-gray-300 shadow-sm focus:border-indigo-500 focus:ring-indigo-500 sm:text-sm" placeholder="Pega tu clave aquí (se guardará localmente)">
                    <button id="clearApiKeyBtn" class="rounded-md border border-gray-300 bg-white px-3 py-2 text-xs font-medium text-gray-700 shadow-sm hover:bg-gray-50">Borrar</button>
                </div>
            </div>

            <!-- DRUG & INDICATION INPUTS -->
            <div class="grid grid-cols-1 md:grid-cols-2 gap-6 border-t pt-6">
                <div>
                    <label for="dci" class="block text-sm font-medium text-gray-700">Nombre del Medicamento (DCI)</label>
                    <input type="text" id="dci" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-indigo-500 focus:ring-indigo-500 sm:text-sm" placeholder="Ej: Ofatumumab">
                </div>
                <div>
                    <label for="indication" class="block text-sm font-medium text-gray-700">Indicación Principal Solicitada</label>
                    <input type="text" id="indication" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-indigo-500 focus:ring-indigo-500 sm:text-sm" placeholder="Ej: Esclerosis Múltiple Recurrente">
                </div>
            </div>

            <!-- ACTION BUTTON & STATUS -->
            <div class="flex items-center space-x-4">
                <button id="generateBtn" class="inline-flex items-center rounded-md border border-transparent bg-indigo-600 px-4 py-2 text-sm font-medium text-white shadow-sm hover:bg-indigo-700 focus:outline-none focus:ring-2 focus:ring-indigo-500 focus:ring-offset-2">
                    Generar Informe Completo
                </button>
                <div id="loader" class="loader hidden"></div>
                <p id="status" class="text-sm text-gray-600 status-message"></p>
            </div>

            <!-- FINAL RESULT OUTPUT -->
            <div id="result-container" class="hidden border-t pt-6">
                <label for="report-frame" class="block text-sm font-bold text-green-700">Informe HTML Generado</label>
                <div class="mt-2">
                    <iframe id="report-frame" title="Informe Final"></iframe>
                </div>
                <textarea id="hidden-html-source" class="hidden"></textarea>
                <div class="mt-4 flex flex-wrap gap-3">
                    <button id="copyBtn" class="inline-flex items-center rounded-md border border-transparent bg-green-600 px-4 py-2 text-sm font-medium text-white shadow-sm hover:bg-green-700">
                        Copiar Código HTML
                    </button>
                    <button id="downloadBtn" class="inline-flex items-center rounded-md border border-gray-300 bg-white px-4 py-2 text-sm font-medium text-gray-700 shadow-sm hover:bg-gray-50">
                        Descargar como .html
                    </button>
                </div>
            </div>
        </div>
    </div>

<script>
    // --- DOM Elements ---
    const generateBtn = document.getElementById('generateBtn');
    const apiKeyInput = document.getElementById('apiKey');
    const clearApiKeyBtn = document.getElementById('clearApiKeyBtn');
    const dciInput = document.getElementById('dci');
    const indicationInput = document.getElementById('indication');
    const loader = document.getElementById('loader');
    const statusEl = document.getElementById('status');
    const resultContainer = document.getElementById('result-container');
    const reportFrame = document.getElementById('report-frame');
    const hiddenHtmlSource = document.getElementById('hidden-html-source');
    const copyBtn = document.getElementById('copyBtn');
    const downloadBtn = document.getElementById('downloadBtn');

    const API_KEY_STORAGE_KEY = 'CONAMEI_ASSISTANT_API_KEY';
    let lastStatusMessage = '';

    // =========================================================================
    // ===          HIGH-FIDELITY FINAL PROMPT TEMPLATE (BLUEPRINT)          ===
    // =========================================================================
    const finalPromptTemplate = {
        "prompt_instructions": {
            "role": "Actúa como un motor de evaluación de HTA y desarrollador web experto, con la tarea de replicar y automatizar el informe oficial del comité técnico de CONAMEI para la inclusión de medicamentos en el Cuadro Nacional de Medicamentos Básicos (CNMB) de Ecuador.",
            "task": "Tu tarea es generar un único archivo HTML completo y válido que sea una réplica visual y estructuralmente idéntica del formato oficial de CONAMEI, usando la estructura y contenido de `report_content`. La fidelidad al formato del ejemplo es máxima. Primero, rellena las secciones informativas (1-7, 9-10). Segundo, para la 'CONCLUSIÓN DEL REVISOR' (Sección 8), no uses una plantilla rígida; en su lugar, sintetiza un párrafo conclusivo balanceado que resuma los hallazgos clave de eficacia, seguridad, económicos y de conveniencia. Tercero, para la 'MATRIZ 1: EVALUACIÓN INICIAL', aplica la lógica de `automated_evaluation_logic` para calcular el puntaje y la decisión, y genera justificaciones concisas para cada parámetro basadas en la evidencia del informe. El resultado final debe ser solo el código HTML puro.",
            "styling_requirements": {
                "framework": "No uses un framework. Replica el estilo usando un único bloque `<style>` en el `<head>`. Utiliza fuentes como Calibri y Arial, un diseño de página A4 fijo, y tablas con bordes negros (`1px solid black`). El informe debe ser multi-página usando `page-break-before: always;` en los `div` de sección apropiados para simular un documento."
            },
            "automated_evaluation_logic": {
                "conclusion_logic": "Para la Sección 8 ('CONCLUSIÓN DEL REVISOR'), escribe un párrafo de conclusión profesional y equilibrado. Resume los hallazgos más importantes de las secciones 5 (Eficacia/Seguridad), 6 (Economía) y 7 (Conveniencia) para justificar si el medicamento representa o no un valor añadido para el sistema de salud ecuatoriano.",
                "matrix_logic": {
                    "overall_goal": "Completa de forma autónoma la 'MATRIZ 1: EVALUACIÓN INICIAL (Resumen)'. No debes copiar los puntajes; debes calcularlos y justificarlos.",
                    "step_by_step_process": [
                        "1. Para cada criterio en `parameters` de la sección 'MATRIZ', analiza la evidencia presentada en el resto del informe para determinar el 'RESULTADO' correcto.",
                        "2. Busca en `scoring_rules` la calificación numérica (`score`) correspondiente y asígnala.",
                        "3. Genera una justificación concisa y específica para CADA calificación.",
                        "4. Suma todas las calificaciones para obtener el 'PUNTAJE TOTAL'.",
                        "5. Aplica la `decision_rule` para determinar la 'DECISIÓN' final."
                    ],
                    "scoring_rules": {
                        "¿Cuál es la calidad de la evidencia científica de los documentos analizados para la indicación solicitada (utilizar una escala validada)?": { "Alta": 2, "Moderada": 1, "Baja o muy baja": 0 },
                        "¿Cuál es la fase de investigación clínica, con resultados publicados, en la que se encuentra el medicamento para la indicación solicitada al momento de la solicitud?": { "Fase IV+": 2, "Fase III+": 1, "Fase IV-": 0, "Fase III-": -1 },
                        "¿Es un medicamento considerado como esencial por la OMS para la indicación solicitada?": { "Si": 1, "No": 0 },
                        "¿Mejora el desenlace final de la enfermedad para la cual se solicitó?": { "Si": 1, "No y/o se desconoce": 0 },
                        "¿La eficacia del medicamento para la indicación solicitada es superior, igual o inferior al comparador (CNMB) o los mejores cuidados de soporte?": { "Superior": 1, "No Inferior": 0, "Inferior": -1 },
                        "¿Mejora la calidad de vida del paciente cuando se evalúa mediante una escala validada?": { "Si": 1, "No y/o se desconoce": 0 },
                        "¿El medicamento puede provocar reacciones adversas letales o graves durante su uso?": { "Poco frecuente": 0, "Frecuente": -1, "Muy frecuente": -2 },
                        "¿El medicamento es más seguro que las alternativas terapéuticas disponibles en el CNMB para la indicación solicitada?": { "Si": 1, "No y/o se desconoce": 0 },
                        "¿Existen alertas sanitarias graves emitidas por una agencia sanitaria de alta vigilancia y/o OMS, para el medicamento solicitado?": { "Si": -1, "No": 1 },
                        "¿La indicación solicitada tiene una prevalencia mayor al 5% según los registros epidemiológicos nacionales?": { "Si": 1, "No": 0 },
                        "¿Existe una alternativa terapéutica dentro del CNMB para la indicación solicitada?": { "Si": 0, "No": 1 },
                        "¿El medicamento solicitado mejora la adherencia del paciente al tratamiento y/o reduce la estancia hospitalaria?": { "Si": 1, "No": 0 },
                        "¿El costo del tratamiento frente al comparador (o los mejores cuidados de soporte, cuando no existe comparador en el CNMB) es menor, igual o mayor?": { "Menor": 1, "Igual": 0, "Mayor": -1 }
                    },
                    "decision_rule": { "threshold": 7, "pass_text": "PASA A SEGUNDA ETAPA", "fail_text": "NO PASA ETAPA" }
                }
            },
            "final_output": "El resultado debe ser un único bloque de código HTML que comience con `<!DOCTYPE html>` y termine con `</html>`, sin ningún texto o explicación adicional fuera del código."
        },
        "report_content": {
            "report_metadata": { "report_id": "CONAMEI-2025-0X", "is_second_stage": true },
            "sections": [
                { "section_number": "1", "title": "IDENTIFICACIÓN DEL MEDICAMENTO", "content_type": "key_value_table", "data": [
                    {"key": "1.1. Código ATC", "value": null}, {"key": "1.2. DCI", "value": null}, {"key": "1.3. Forma farmacéutica (CNMB)", "value": null}, {"key": "1.4. Formas farmacéuticas (ARCSA)", "value": null},
                    {"key": "1.5. Concentración", "value": null}, {"key": "1.6. Vía de administración", "value": null}, {"key": "1.7. Presentación comercial", "value": null}, {"key": "1.8. Información sanitaria", "value": null}
                ]},
                { "section_number": "2", "title": "INDICACIÓN TERAPÉUTICA", "content_type": "key_value_table", "data": [
                    {"key": "2.1. Indicación terapéutica para la cual se solicita", "value": null}, {"key": "2.2. Mecanismo de acción", "value": null}, {"key": "2.3. Pauta de dosificación", "value": null},
                    {"key": "2.4. Alternativas terapéuticas disponibles en el CNMB vigente", "value": null}, {"key": "2.5. Alternativas terapéuticas no presentes en el CNMB vigente", "value": null}
                ]},
                { "section_number": "3", "title": "POLÍTICAS DE COBERTURA", "content_type": "multi_table", "tables": [
                    { "title": null, "headers": ["País/Agencia Sanitaria", "Indicación cubierta", "Fecha inicio cobertura"], "rows": [] },
                    { "title": "Indicaciones formalmente aprobadas para comercialización", "headers": ["Agencia sanitaria", "Indicación aprobada", "Tipo aprobación"], "rows": [] }
                ]},
                { "section_number": "4", "title": "BÚSQUEDA DE EVIDENCIA CIENTÍFICA", "content_type": "pico_table", "data": [
                    {"key": "P (Población)", "value": null}, {"key": "I (Intervención)", "value": null}, {"key": "C (Comparador)", "value": null}, {"key": "O (Resultado)", "value": null}
                ]},
                { "section_number": "5", "title": "DATOS DE EFICACIA Y SEGURIDAD", "content_type": "efficacy_safety_section", "nma_summary": { "reference": null, "design": null, "findings": null }, "grade_tables": [
                    { "title": null, "headers": [], "rows": [] },
                    { "title": null, "headers": [], "rows": [] }
                ], "safety_summary": { "reference": null, "ram_frequency_severity": null, "ram_details": null, "alerts": null, "is_safer_justification": null }},
                { "section_number": "6", "title": "DATOS ECONÓMICOS", "content_type": "economic_section", "cost_table": { "headers": ["Parámetros", null, null], "rows": [] }, "cost_analysis": { "question": null, "answer": null }, "pharmacoeconomic_study": { "summary": null }},
                { "section_number": "7", "title": "DATOS DE CONVENIENCIA", "content_type": "convenience_table", "headers": ["Parámetro", "Respuesta", "Justificativo"], "rows": []},
                { "section_number": "8", "title": "CONCLUSIÓN DEL REVISOR", "content_type": "text_block", "text": null },
                { "section_number": "9", "title": "FIRMA DE RESPONSABILIDAD", "content_type": "signature_block", "data": { "elaborator": "_________________________", "institution": "_________________________", "date": "_________________________" }},
                { "section_number": "10", "title": "REFERENCIAS", "content_type": "list", "items": []},
                { "section_number": null, "title": "MATRIZ 1: EVALUACIÓN INICIAL (Resumen)", "content_type": "automated_evaluation_matrix", "drug_info": { "dci": null, "comparator": null },
                    "scoring": { "total_score": null, "decision": null },
                    "parameters": [
                        {"category": "EFICACIA", "question": "¿Cuál es la calidad de la evidencia científica de los documentos analizados para la indicación solicitada (utilizar una escala validada)?", "result": null, "score": null, "justification": null},
                        {"category": "EFICACIA", "question": "¿Cuál es la fase de investigación clínica, con resultados publicados, en la que se encuentra el medicamento para la indicación solicitada al momento de la solicitud?", "result": null, "score": null, "justification": null},
                        {"category": "EFICACIA", "question": "¿Es un medicamento considerado como esencial por la OMS para la indicación solicitada?", "result": null, "score": null, "justification": null},
                        {"category": "EFICACIA", "question": "¿Mejora el desenlace final de la enfermedad para la cual se solicitó?", "result": null, "score": null, "justification": null},
                        {"category": "EFICACIA", "question": "¿La eficacia del medicamento para la indicación solicitada es superior, igual o inferior al comparador (CNMB) o los mejores cuidados de soporte?", "result": null, "score": null, "justification": null},
                        {"category": "EFICACIA", "question": "¿Mejora la calidad de vida del paciente cuando se evalúa mediante una escala validada?", "result": null, "score": null, "justification": null},
                        {"category": "SEGURIDAD", "question": "¿El medicamento puede provocar reacciones adversas letales o graves durante su uso?", "result": null, "score": null, "justification": null},
                        {"category": "SEGURIDAD", "question": "¿El medicamento es más seguro que las alternativas terapéuticas disponibles en el CNMB para la indicación solicitada?", "result": null, "score": null, "justification": null},
                        {"category": "SEGURIDAD", "question": "¿Existen alertas sanitarias graves emitidas por una agencia sanitaria de alta vigilancia y/o OMS, para el medicamento solicitado?", "result": null, "score": null, "justification": null},
                        {"category": "PREVALENCIA / FRECUENCIA", "question": "¿La indicación solicitada tiene una prevalencia mayor al 5% según los registros epidemiológicos nacionales?", "result": null, "score": null, "justification": null},
                        {"category": "CONVENIENCIA", "question": "¿Existe una alternativa terapéutica dentro del CNMB para la indicación solicitada?", "result": null, "score": null, "justification": null},
                        {"category": "CONVENIENCIA", "question": "¿El medicamento solicitado mejora la adherencia del paciente al tratamiento y/o reduce la estancia hospitalaria?", "result": null, "score": null, "justification": null},
                        {"category": "COSTO", "question": "¿El costo del tratamiento frente al comparador (o los mejores cuidados de soporte, cuando no existe comparador en el CNMB) es menor, igual o mayor?", "result": null, "score": null, "justification": null}
                    ]
                }
            ]
        }
    };
    
    // --- Application Logic ---
    function showStatus(message, isTemporary = false, duration = 4000) {
        statusEl.textContent = message;
        if (!isTemporary) { lastStatusMessage = message; } 
        else {
            setTimeout(() => {
                if (statusEl.textContent === message) { statusEl.textContent = lastStatusMessage; }
            }, duration);
        }
    }

    document.addEventListener('DOMContentLoaded', () => {
        const savedApiKey = localStorage.getItem(API_KEY_STORAGE_KEY);
        if (savedApiKey) {
            apiKeyInput.value = savedApiKey;
            showStatus('API Key cargada desde el almacenamiento local.', true);
        }
    });

    apiKeyInput.addEventListener('input', () => localStorage.setItem(API_KEY_STORAGE_KEY, apiKeyInput.value));
    clearApiKeyBtn.addEventListener('click', () => {
        localStorage.removeItem(API_KEY_STORAGE_KEY);
        apiKeyInput.value = '';
        showStatus('Clave de API borrada del almacenamiento local.', true);
    });

    // =========================================================================
    // ===                 MAIN AUTOMATED WORKFLOW FUNCTION                  ===
    // =========================================================================
    async function handleGenerateClick() {
        const apiKey = apiKeyInput.value.trim();
        const dci = dciInput.value.trim();
        const indication = indicationInput.value.trim();

        if (!apiKey || !dci || !indication) {
            showStatus("Por favor, completa todos los campos: API Key, Medicamento e Indicación.");
            return;
        }

        generateBtn.disabled = true;
        loader.classList.remove('hidden');
        resultContainer.classList.add('hidden');
        
        try {
            // --- STAGE 1: GATHER EVIDENCE ---
            showStatus('Etapa 1: Buscando y sintetizando evidencia... (Puede tardar ~1 minuto)');
            const searcherPrompt = buildSearcherPrompt(dci, indication);
            const API_URL = `https://generativelanguage.googleapis.com/v1beta/models/gemini-1.5-flash-latest:generateContent?key=${apiKey}`;
            
            const evidenceResponse = await fetch(API_URL, {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ contents: [{ parts: [{ text: searcherPrompt }] }] })
            });

            if (!evidenceResponse.ok) {
                const errorData = await evidenceResponse.json();
                throw new Error(`Error en API (Etapa 1): ${evidenceResponse.status} - ${errorData.error?.message || 'Error desconocido'}`);
            }

            const evidenceData = await evidenceResponse.json();
            let evidenceText = evidenceData.candidates[0].content.parts[0].text;
            evidenceText = evidenceText.replace(/^```json\s*|```\s*$/g, '').trim();
            const evidence = JSON.parse(evidenceText);

            // --- PAYLOAD ASSEMBLY ---
            showStatus('Etapa 1 completada. Ensamblando el prompt final para la generación del informe...');
            const finalPrompt = buildFinalPrompt(dci, indication, evidence);
            
            // --- STAGE 2: GENERATE FINAL HTML REPORT ---
            showStatus('Etapa 2: Generando el informe HTML final...');
            const finalReportResponse = await fetch(API_URL, {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ contents: [ { parts: [{ text: JSON.stringify(finalPrompt) }] }] })
            });
            
            if (!finalReportResponse.ok) {
                const errorData = await finalReportResponse.json();
                throw new Error(`Error en API (Etapa 2): ${finalReportResponse.status} - ${errorData.error?.message || 'Error desconocido'}`);
            }
            
            const finalReportData = await finalReportResponse.json();
            let finalHtml = finalReportData.candidates[0].content.parts[0].text;
            finalHtml = finalHtml.replace(/^```html\s*|```\s*$/g, '').trim();

            // --- RENDER FINAL REPORT ---
            hiddenHtmlSource.value = finalHtml;
            reportFrame.srcdoc = finalHtml;
            resultContainer.classList.remove('hidden');
            showStatus('¡Informe completo generado con éxito!');

        } catch (error) {
            console.error(error);
            let errorMessage = `Error: ${error.message}. Revisa la consola (F12) para más detalles.`;
            if (error.message.includes('API key not valid')) {
                errorMessage = 'Error: La API Key no es válida. Por favor, verifica que sea correcta.';
            } else if (error instanceof SyntaxError) {
                errorMessage = 'Error: La respuesta de la API no es un JSON/HTML válido. Inténtalo de nuevo.';
            }
            showStatus(errorMessage);
        } finally {
            generateBtn.disabled = false;
            loader.classList.add('hidden');
        }
    }

    // =========================================================================
    // ===              ADVANCED EVIDENCE GATHERING PROMPT BUILDER           ===
    // =========================================================================
    function buildSearcherPrompt(dci, indication) {
        return `
            Actúa como un investigador médico experto y analista de HTA. Para el medicamento "${dci}" para la indicación "${indication}", busca y sintetiza la siguiente información, devolviendo un ÚNICO objeto JSON. Sé exhaustivo y preciso.

            {
              "identificacion": {
                "atc_code": "Busca el código ATC", "pharma_form_cnmb": "Busca la forma farmacéutica general (líquido parenteral, etc.)", "pharma_form_arcsa": "Busca la forma farmacéutica específica aprobada (solución inyectable en pluma precargada, etc.)",
                "concentration": "Busca la concentración más común", "admin_route": "Busca la vía de administración", "commercial_presentation": "Busca una presentación comercial típica", "sanitary_info": "Busca el número de registro sanitario de ARCSA (Ecuador) si está disponible y la fecha de expiración, o el de FDA/EMA si no."
              },
              "indicacion": {
                "mechanism_of_action": "Describe el mecanismo de acción en 2-3 frases.", "dosage_guideline": "Describe la pauta de dosificación estándar.", "alternatives_cnmb": "Menciona las alternativas terapéuticas clave DISPONIBLES en el CNMB de Ecuador.",
                "alternatives_not_cnmb": "Menciona otras terapias de alta eficacia relevantes NO disponibles en el CNMB de Ecuador."
              },
              "cobertura": {
                "policies": [
                  {"country_agency": "NICE (Reino Unido)", "indication": "Busca la indicación cubierta y resumen de la recomendación", "date": "Busca la fecha (dd/mm/aaaa)"},
                  {"country_agency": "ESPAÑA", "indication": "Busca la indicación cubierta y resumen de la recomendación", "date": "Busca la fecha (dd/mm/aaaa)"}
                ],
                "approvals": [
                  {"agency": "EMA", "indication": "Busca la indicación aprobada", "type": "Busca el tipo de aprobación (Monitoreo adicional, etc.)"},
                  {"agency": "FDA", "indication": "Busca la indicación aprobada", "type": "Busca el tipo de aprobación (Huérfano, etc.)"},
                  {"agency": "ARCSA", "indication": "Busca la indicación aprobada en Ecuador", "type": "Busca el tipo de aprobación (Regular, etc.)"}
                ]
              },
              "eficacia_seguridad": {
                "pico_c": "Identifica el comparador más relevante y de alta eficacia para ${dci} en ${indication}, preferiblemente uno que también esté en el CNMB.",
                "nma_summary": { "reference": "Encuentra la referencia en formato Vancouver de un Metaanálisis en Red (NMA) clave que compare ${dci} con otros.", "design": "Describe el diseño del NMA.", "findings": "Resume los hallazgos clave de eficacia del NMA, comparando ${dci} con su principal competidor en Tasa Anual de Recaídas (ARR) y Progresión de Discapacidad (CDP)." },
                "grade_tables": [
                    {"title": "Tasa de Recaída Anualizada (ARR) vs. Placebo", "headers": ["Tratamiento", "Efecto Relativo (RR)", "IC 95%"], "rows": [ /* Poblar con 4-5 tratamientos de alta eficacia del NMA, incluyendo ${dci} y su comparador, con sus valores numéricos. */ ]},
                    {"title": "Progresión de Discapacidad a 3 meses (3mCDP) vs. Placebo", "headers": ["Tratamiento", "Hazard Ratio (HR)", "IC 95%"], "rows": [ /* Poblar con 4-5 tratamientos de alta eficacia del NMA, incluyendo ${dci} y su comparador, con sus valores numéricos. */ ]}
                ],
                "safety_summary": { "reference": "Encuentra la referencia en formato Vancouver de un estudio o revisión clave sobre la seguridad de ${dci}.", "ram_frequency_severity": "Resume las RAM muy frecuentes y frecuentes y su severidad típica.", "ram_details": "Describe brevemente los tipos de eventos adversos más importantes.", "alerts": "Describe si existen alertas de agencias de alta vigilancia (ej. riesgo de infecciones) y de qué tratan.", "is_safer_justification": "Compara el perfil de seguridad de ${dci} con su comparador principal y concluye si es más seguro, explicando por qué." }
              },
              "economia": {
                "cost_comparator_name": "Nombre del comparador para el costo",
                "cost_rows": [
                  {"parameter": "Precio unitario (SERCOP)", "intervention_value": "Busca el precio unitario en USD en SERCOP, Ecuador para ${dci}", "comparator_value": "Busca el precio unitario en USD en SERCOP, Ecuador para el comparador"},
                  {"parameter": "Posología Anual", "intervention_value": "Calcula las unidades necesarias por año para ${dci}", "comparator_value": "Calcula las unidades necesarias por año para el comparador"},
                  {"parameter": "Costo del tratamiento por paciente al año", "intervention_value": "Calcula el costo anual total para ${dci}", "comparator_value": "Calcula el costo anual total para el comparador"}
                ],
                "cost_analysis_answer": "Calcula la diferencia de costo anual y declara si ${dci} es más o menos costoso y por cuánto.",
                "pharmacoeconomic_study": "Resume la conclusión de un estudio farmacoeconómico (ej. de NICE o CADTH) sobre si ${dci} se considera costo-efectivo."
              },
              "conveniencia": {
                "rows": [
                  {"parameter": "¿La frecuencia de administración es menor en relación con su/sus comparadores del CNMB?", "response": "Si/No", "justification": "Justifica la respuesta comparando la frecuencia de ${dci} vs el comparador."},
                  {"parameter": "¿Mejora la adherencia al tratamiento en relación con su/sus comparadores del CNMB?", "response": "Si/No", "justification": "Justifica si la autoadministración en casa podría mejorar la adherencia a largo plazo."},
                  {"parameter": "¿Disminuye el tiempo de hospitalización del paciente en relación con su/sus comparadores del CNMB?", "response": "Si/No", "justification": "Justifica si la administración domiciliaria elimina la necesidad de visitas a centros de infusión y reduce la carga asistencial."}
                ]
              },
              "bibliografia": {
                "items": [ /* Genera una lista de 5-10 referencias clave en formato Vancouver, incluyendo los estudios de eficacia, seguridad y farmacoeconomía citados previamente. */ ]
              },
              "matriz_data": {
                "quality_of_evidence": "Evalúa (Alta, Moderada, Baja o muy baja)", "research_phase": "Identifica (Fase IV+, Fase III+, etc.)", "who_essential": "Indica (Si/No)", "improves_outcome": "Indica (Si / No y/o se desconoce)", "efficacy_comparison": "Compara (Superior, No Inferior, Inferior)", "improves_qol": "Indica (Si / No y/o se desconoce)",
                "lethal_adverse_reactions": "Clasifica (Poco frecuente, Frecuente, Muy frecuente)", "is_safer": "Indica (Si / No y/o se desconoce)", "has_safety_alerts": "Indica si existen alertas (Si/No)", "prevalence_over_5_percent": "Estima para Ecuador (Si/No)", "is_cnmb_alternative_available": "Confirma (Si/No)",
                "improves_adherence_or_reduces_hospitalization": "Indica (Si/No)", "cost_comparison": "Compara costo (Menor, Igual, Mayor)"
              }
            }`;
    }
    
    // =========================================================================
    // ===                 HIGH-FIDELITY PROMPT POPULATOR                    ===
    // =========================================================================
    function buildFinalPrompt(dci, indication, evidence) {
        let template = JSON.parse(JSON.stringify(finalPromptTemplate));
        
        // --- SECTION 1 ---
        let sec1 = template.report_content.sections.find(s => s.section_number === "1").data;
        sec1[0].value = evidence.identificacion.atc_code;
        sec1[1].value = dci;
        sec1[2].value = evidence.identificacion.pharma_form_cnmb;
        sec1[3].value = evidence.identificacion.pharma_form_arcsa;
        sec1[4].value = evidence.identificacion.concentration;
        sec1[5].value = evidence.identificacion.admin_route;
        sec1[6].value = evidence.identificacion.commercial_presentation;
        sec1[7].value = evidence.identificacion.sanitary_info;

        // --- SECTION 2 ---
        let sec2 = template.report_content.sections.find(s => s.section_number === "2").data;
        sec2[0].value = indication;
        sec2[1].value = evidence.indicacion.mechanism_of_action;
        sec2[2].value = evidence.indicacion.dosage_guideline;
        sec2[3].value = evidence.indicacion.alternatives_cnmb;
        sec2[4].value = evidence.indicacion.alternatives_not_cnmb;

        // --- SECTION 3 ---
        let sec3 = template.report_content.sections.find(s => s.section_number === "3");
        sec3.tables[0].rows = evidence.cobertura.policies.map(p => [p.country_agency, p.indication, p.date]);
        sec3.tables[1].rows = evidence.cobertura.approvals.map(a => [a.agency, a.indication, a.type]);
        
        // --- SECTION 4 ---
        let sec4 = template.report_content.sections.find(s => s.section_number === "4").data;
        sec4[0].value = `Pacientes adultos con ${indication}.`;
        sec4[1].value = dci;
        sec4[2].value = evidence.eficacia_seguridad.pico_c;
        sec4[3].value = "Reducción de TAB, progresión de discapacidad, actividad en RM y seguridad.";

        // --- SECTION 5 ---
        let sec5 = template.report_content.sections.find(s => s.section_number === "5");
        sec5.nma_summary = evidence.eficacia_seguridad.nma_summary;
        sec5.grade_tables = evidence.eficacia_seguridad.grade_tables.map(t => ({...t, rows: t.rows.map(r => Object.values(r)) }));
        sec5.safety_summary = evidence.eficacia_seguridad.safety_summary;

        // --- SECTION 6 ---
        let sec6 = template.report_content.sections.find(s => s.section_number === "6");
        sec6.cost_table.headers = ["Parámetros", dci.toUpperCase(), evidence.economia.cost_comparator_name.toUpperCase()];
        sec6.cost_table.rows = evidence.economia.cost_rows.map(r => [r.parameter, r.intervention_value, r.comparator_value]);
        sec6.cost_analysis.question = `¿El costo del tratamiento es menor que el comparador?`;
        sec6.cost_analysis.answer = evidence.economia.cost_analysis_answer;
        sec6.pharmacoeconomic_study.summary = evidence.economia.pharmacoeconomic_study;

        // --- SECTION 7 ---
        let sec7 = template.report_content.sections.find(s => s.section_number === "7");
        sec7.rows = evidence.conveniencia.rows.map(r => [r.parameter, r.response, r.justification]);

        // --- SECTION 10 ---
        let sec10 = template.report_content.sections.find(s => s.section_number === "10");
        sec10.items = evidence.bibliografia.items;
        
        // --- FINAL MATRIX ---
        let matrix = template.report_content.sections.find(s => s.content_type === "automated_evaluation_matrix");
        matrix.drug_info.dci = dci;
        matrix.drug_info.comparator = evidence.eficacia_seguridad.pico_c;
        const matrixData = evidence.matriz_data;
        matrix.parameters.forEach(p => {
            if (p.question.includes("calidad de la evidencia")) p.result = matrixData.quality_of_evidence;
            if (p.question.includes("fase de investigación")) p.result = matrixData.research_phase;
            if (p.question.includes("esencial por la OMS")) p.result = matrixData.who_essential;
            if (p.question.includes("desenlace final")) p.result = matrixData.improves_outcome;
            if (p.question.includes("eficacia es superior")) p.result = matrixData.efficacy_comparison;
            if (p.question.includes("calidad de vida")) p.result = matrixData.improves_qol;
            if (p.question.includes("reacciones adversas letales")) p.result = matrixData.lethal_adverse_reactions;
            if (p.question.includes("más seguro que las alternativas")) p.result = matrixData.is_safer;
            if (p.question.includes("alertas sanitarias graves")) p.result = matrixData.has_safety_alerts;
            if (p.question.includes("prevalencia mayor al 5%")) p.result = matrixData.prevalence_over_5_percent;
            if (p.question.includes("alternativa terapéutica dentro del CNMB")) p.result = matrixData.is_cnmb_alternative_available;
            if (p.question.includes("mejora la adherencia")) p.result = matrixData.improves_adherence_or_reduces_hospitalization;
            if (p.question.includes("costo del tratamiento")) p.result = matrixData.cost_comparison;
        });

        return template;
    }

    // --- Button Event Listeners ---
    generateBtn.addEventListener('click', handleGenerateClick);
    
    copyBtn.addEventListener('click', () => { 
        hiddenHtmlSource.select();
        navigator.clipboard.writeText(hiddenHtmlSource.value); 
        showStatus('¡Código HTML copiado al portapapeles!', true);
    });

    downloadBtn.addEventListener('click', () => { 
        const dciForFile = dciInput.value.trim().toLowerCase().replace(/\s+/g, '_') || 'informe'; 
        const blob = new Blob([hiddenHtmlSource.value], { type: 'text/html' }); 
        const a = document.createElement('a'); 
        a.href = URL.createObjectURL(blob); 
        a.download = `informe_conamei_${dciForFile}.html`; 
        document.body.appendChild(a); 
        a.click(); 
        document.body.removeChild(a); 
        showStatus('Informe HTML descargado.', true);
    });
</script>

</body>
</html>
