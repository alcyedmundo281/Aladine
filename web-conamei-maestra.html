<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Asistente de Generación de Informes CONAMEI (v2)</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <style>
        body { font-family: 'Inter', sans-serif; }
        .loader {
            border: 4px solid #f3f3f3;
            border-top: 4px solid #3b82f6;
            border-radius: 50%;
            width: 30px;
            height: 30px;
            animation: spin 1s linear infinite;
        }
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        .status-message {
            transition: opacity 0.5s ease-in-out;
        }
    </style>
</head>
<body class="bg-gray-100 p-4 sm:p-6 md:p-8">
    <div class="max-w-4xl mx-auto bg-white rounded-xl shadow-lg overflow-hidden">
        <div class="bg-gray-800 p-6">
            <h1 class="text-2xl font-bold text-white">Asistente de Generación de Informes CONAMEI</h1>
            <p class="text-gray-300 mt-1">Automatiza la búsqueda de evidencia y la creación de prompts para Google AI.</p>
        </div>

        <div class="p-6 md:p-8 space-y-6">
            <!-- PASO 0: API KEY -->
            <div>
                <label for="apiKey" class="block text-sm font-medium text-gray-700">Tu API Key de Google AI</label>
                <div class="mt-1 flex items-center space-x-2">
                    <input type="password" id="apiKey" class="block w-full rounded-md border-gray-300 shadow-sm focus:border-indigo-500 focus:ring-indigo-500 sm:text-sm" placeholder="Pega tu clave aquí (se guardará localmente)">
                    <button id="clearApiKeyBtn" class="rounded-md border border-gray-300 bg-white px-3 py-2 text-xs font-medium text-gray-700 shadow-sm hover:bg-gray-50">Borrar</button>
                </div>
                <p class="mt-1 text-xs text-gray-500">Tu clave se guarda de forma segura en tu navegador.</p>
            </div>

            <!-- PASO 1: INPUTS -->
            <div class="grid grid-cols-1 md:grid-cols-2 gap-6 border-t pt-6">
                <div>
                    <label for="dci" class="block text-sm font-medium text-gray-700">Nombre del Medicamento (DCI)</label>
                    <input type="text" id="dci" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-indigo-500 focus:ring-indigo-500 sm:text-sm" placeholder="Ej: Ofatumumab">
                </div>
                <div>
                    <label for="indication" class="block text-sm font-medium text-gray-700">Indicación Principal Solicitada</label>
                    <input type="text" id="indication" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-indigo-500 focus:ring-indigo-500 sm:text-sm" placeholder="Ej: Esclerosis Múltiple Recurrente">
                </div>
            </div>

            <!-- BOTÓN DE ACCIÓN Y ESTADO -->
            <div class="flex items-center space-x-4">
                <button id="generateBtn" class="inline-flex items-center rounded-md border border-transparent bg-blue-600 px-4 py-2 text-sm font-medium text-white shadow-sm hover:bg-blue-700 focus:outline-none focus:ring-2 focus:ring-blue-500 focus:ring-offset-2">
                    1. Buscar Evidencia y Generar Prompt
                </button>
                <div id="loader" class="loader hidden"></div>
                <p id="status" class="text-sm text-gray-600 status-message"></p>
            </div>

            <!-- PASO 2: RESULTADO -->
            <div id="result-container" class="hidden border-t pt-6">
                <label for="result" class="block text-sm font-bold text-green-700">Prompt JSON Generado (Listo para AI Studio)</label>
                <textarea id="result" rows="20" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm font-mono text-xs focus:border-indigo-500 focus:ring-indigo-500"></textarea>
                <div class="mt-4 flex flex-wrap gap-3">
                    <button id="copyBtn" class="inline-flex items-center rounded-md border border-transparent bg-green-600 px-4 py-2 text-sm font-medium text-white shadow-sm hover:bg-green-700">
                        2. Copiar Prompt
                    </button>
                    <button id="downloadBtn" class="inline-flex items-center rounded-md border border-gray-300 bg-white px-4 py-2 text-sm font-medium text-gray-700 shadow-sm hover:bg-gray-50">
                        Descargar como .json
                    </button>
                </div>
                 <p class="mt-2 text-xs text-gray-500">Ahora, ve a Google AI Studio, pega este prompt y ejecuta para obtener el informe HTML final.</p>
            </div>
        </div>
    </div>

    <script>
        const generateBtn = document.getElementById('generateBtn');
        const apiKeyInput = document.getElementById('apiKey');
        const clearApiKeyBtn = document.getElementById('clearApiKeyBtn');
        const dciInput = document.getElementById('dci');
        const indicationInput = document.getElementById('indication');
        const loader = document.getElementById('loader');
        const statusEl = document.getElementById('status');
        const resultContainer = document.getElementById('result-container');
        const resultTextarea = document.getElementById('result');
        const copyBtn = document.getElementById('copyBtn');
        const downloadBtn = document.getElementById('downloadBtn');

        const API_KEY_STORAGE_KEY = 'CONAMEI_ASSISTANT_API_KEY_V2';
        let lastStatusMessage = ''; 

        // --- PLANTILLA MAESTRA DEL PROMPT FINAL (ESTRUCTURA AVANZADA) ---
        const finalPromptTemplate = {
          "prompt_instructions": {
            "role": "Actúa como un motor de evaluación de HTA y desarrollador web experto, con la tarea de replicar y automatizar el informe oficial del comité técnico de CONAMEI para la inclusión de medicamentos en el Cuadro Nacional de Medicamentos Básicos (CNMB) de Ecuador.",
            "task": "Tu tarea es generar un único archivo HTML completo y válido que sea una réplica visual y estructuralmente idéntica del formulario CONAMEI. Utiliza la información en `report_content` para rellenar las secciones informativas (1-8, 10-11). Para la Matriz de Evaluación (sección 13) y la Conclusión del Revisor (sección 9), debes aplicar la lógica computacional definida en `automated_evaluation_logic` para calcular los puntajes, justificar cada uno, y generar dinámicamente una conclusión argumentativa y contextualizada para el sistema de salud ecuatoriano.",
            "styling_requirements": {
              "framework": "No uses un framework. Replica el estilo del ejemplo usando un único bloque `<style>` en el `<head>`. Utiliza fuentes como Calibri y Arial, un diseño de página A4 fijo, y tablas con bordes negros (`1px solid black`).",
              "visual_identity": {
                "instruction": "Usa las URLs de las imágenes en `document_layout` para el encabezado, pie de página y casillas de verificación. Una casilla 'marcada' muestra la imagen; una 'no marcada' usa `style='visibility: hidden;'`."
              }
            },
            "grade_and_safety_section_logic": {
              "instruction": "Para la sección 6, 'DATOS DE EFICACIA Y SEGURIDAD', debes construir una sección robusta. Primero, crea el subtítulo '6.1 Resumen de Hallazgos (SoF) / Tabla GRADE'. Luego, para cada objeto en el array `grade_outcomes`, genera una tabla de resumen de hallazgos completa y detallada. Cada tabla debe tener un título claro para el desenlace y todas las columnas de evaluación GRADE. Después de las tablas GRADE, crea el subtítulo '6.2 Datos de Seguridad del medicamento' y renderiza la tabla de seguridad detallada usando los datos de `safety_details` y las imágenes de checkbox."
            },
            "automated_evaluation_logic": {
              "overall_goal": "Tu tarea más crítica es completar de forma autónoma la 'MATRIZ 1: EVALUACIÓN INICIAL' (sección 13) y generar la 'CONCLUSIÓN DEL REVISOR' (sección 9). No debes copiar los puntajes; debes calcularlos y justificarlos basándote en la evidencia presentada.",
              "step_by_step_process": [
                "1. Para cada criterio en el array `parameters`, analiza la evidencia presentada en las secciones 5, 6, 7 y 8 del informe para determinar el 'RESULTADO' correcto. La comparación debe ser siempre contra la alternativa del CNMB.",
                "2. Una vez determinado el 'RESULTADO', busca en el objeto `scoring_rules` la calificación numérica (`score`) correspondiente y asígnala.",
                "3. **Genera una justificación concisa y específica para CADA calificación**, explicando por qué se asignó ese puntaje en base a la evidencia del informe. Ej: 'Eficacia superior al comparador del CNMB (Teriflunomida) según estudios ASCLEPIOS (+1)'.",
                "4. Después de calificar y justificar todos los criterios, suma todas las calificaciones para obtener el 'PUNTAJE TOTAL'.",
                "5. Aplica la `decision_rule` al 'PUNTAJE TOTAL' para determinar la 'DECISIÓN' final.",
                "6. **Genera el texto para la 'CONCLUSIÓN DEL REVISOR' (sección 9)** usando las plantillas de `argumentative_conclusion_logic`. Elige la plantilla 'pass' o 'fail' según la decisión. Sintetiza los argumentos más fuertes de tu evaluación para rellenar los placeholders.",
                "7. Renderiza el informe completo, incluyendo la matriz y la conclusión que has generado."
              ],
              "scoring_rules": {
                "¿Cuál es la calidad de la evidencia científica?": { "Alta": 2, "Moderada": 1, "Baja o muy baja": 0 },
                "¿Cuál es la fase de investigación clínica?": { "Fase IV+": 2, "Fase III+": 1, "Fase IV-": 0, "Fase III-": -1 },
                "¿Es un medicamento considerado como esencial por la OMS?": { "Si": 1, "No": 0 },
                "¿Mejora el desenlace final de la enfermedad?": { "Si": 1, "No y/o se desconoce": 0 },
                "¿La eficacia es superior, igual o inferior al comparador?": { "Superior": 1, "No Inferior": 0, "Inferior": -1 },
                "¿Mejora la calidad de vida del paciente?": { "Si": 1, "No y/o se desconoce": 0 },
                "¿Puede provocar reacciones adversas letales o graves?": { "Poco frecuente": 0, "Frecuente": -1, "Muy frecuente": -2 },
                "¿Es más seguro que las alternativas del CNMB?": { "Si": 1, "No y/o se desconoce": 0 },
                "¿Existen alertas sanitarias graves emitidas?": { "Si": -1, "No": 1 },
                "¿La indicación tiene una prevalencia >5%?": { "Si": 1, "No": 0 },
                "¿Existe una alternativa terapéutica dentro del CNMB?": { "No": 1, "Si": 0 },
                "¿Mejora la adherencia y/o reduce la estancia hospitalaria?": { "Si": 1, "No": 0 },
                "¿El costo del tratamiento frente al comparador es menor, igual o mayor?": { "Menor": 1, "Igual": 0, "Mayor": -1 }
              },
              "decision_rule": { "threshold": 7, "pass_text": "PASA A SEGUNDA ETAPA", "fail_text": "NO PASA ETAPA" },
              "argumentative_conclusion_logic": {
                "pass_template": "Considerando la carga de la Esclerosis Múltiple Recurrente en Ecuador, la evidencia presentada para Ofatumumab demuestra un perfil robusto. Los puntos fuertes clave que sustentan esta evaluación son: [sintetiza los argumentos de eficacia y conveniencia con puntajes positivos, ej., su superioridad de eficacia demostrada en la reducción de brotes y progresión de la discapacidad frente a la alternativa disponible en el CNMB (Teriflunomida), y su conveniente pauta de administración que favorece la adherencia]. Aunque se reconocen consideraciones importantes como [sintetiza los argumentos de seguridad y costo con puntajes negativos o cero, ej., su mayor costo de adquisición y las alertas de seguridad inherentes a su clase terapéutica], el balance beneficio/riesgo general es favorable. Con un puntaje total de [puntaje], que cumple o supera el umbral requerido, se concluye que la tecnología sanitaria presenta méritos suficientes para una evaluación más profunda. **Recomendación:** Se recomienda que Ofatumumab **PASE A LA SEGUNDA ETAPA** de evaluación para su posible inclusión en el CNMB.",
                "fail_template": "Si bien Ofatumumab ha demostrado beneficios en eficacia frente a las alternativas del CNMB, como [sintetiza los argumentos de eficacia con puntajes positivos, ej., la reducción de la tasa de brotes], existen debilidades significativas que impiden una recomendación favorable en esta etapa. Los puntos críticos en contra que fundamentan esta decisión son: [sintetiza los argumentos de seguridad y costo con puntajes negativos, ej., el alto costo incremental que representa una barrera de sostenibilidad para el sistema de salud ecuatoriano, junto con un perfil de seguridad que incluye alertas de clase importantes sin demostrar una superioridad en seguridad sobre el comparador]. Con un puntaje total de [puntaje], que no alcanza el umbral requerido de 7, la propuesta de valor para su inclusión en el Cuadro Nacional de Medicamentos Básicos no es clara en este momento. **Recomendación:** Se recomienda que Ofatumumab **NO PASE A LA SEGUNDA ETAPA** de evaluación hasta que se presente evidencia más sólida sobre su costo-efectividad en el contexto ecuatoriano o se aborden las incertidumbres de seguridad."
              }
            },
            "final_output": "El resultado debe ser un único bloque de código HTML que comience con `<!DOCTYPE html>` y termine con `</html>`, sin ningún texto o explicación adicional fuera del código.",
            "report_content": {
              "document_layout": {
                "header_image_url": "https://i.imgur.com/uT2F8QG.png",
                "footer_image_url": "https://i.imgur.com/5b8tB3B.png",
                "checkbox_image_url": "https://i.imgur.com/8Q9k2oG.png",
                "sns_logo_url": "https://i.imgur.com/L4g2G0F.png"
              },
              "report_metadata": { "report_id": "", "city_date": "", "is_first_stage": false, "is_second_stage": true },
              "sections": [
                { "section_number": "1", "title": "IDENTIFICACIÓN DEL SOLICITANTE", "content_type": "applicant_table", "data": { "institution_name": "", "rpis_options": ["MSP", "IESS", "FF.AA.", "POLICIA"], "selected_rpis": null, "rpc_options": ["SOLCA", "JBG"], "selected_rpc": null, "sns_options": ["ACHPE", "AFEME", "FEQUIFE", "FME"], "selected_sns": null } },
                { "section_number": "2", "title": "IDENTIFICACIÓN DEL MEDICAMENTO", "content_type": "key_value_table", "data": [ {"key": "Código ATC", "value": ""}, {"key": "DCI", "value": ""}, {"key": "Forma farmacéutica (CNMB)", "value": ""}, {"key": "Formas farmacéuticas (ARCSA)", "value": ""}, {"key": "Concentración", "value": ""}, {"key": "Vía de administración", "value": ""}, {"key": "Presentación comercial", "value": ""}, {"key": "Información sanitaria", "value": ""} ] },
                { "section_number": "3", "title": "INDICACIÓN TERAPÉUTICA", "content_type": "key_value_table", "data": [ {"key": "3.1. Indicación terapéutica para la cual se solicita", "value": ""}, {"key": "3.2. Mecanismo de acción", "value": ""}, {"key": "3.3. Pauta de dosificación", "value": ""}, {"key": "3.4. Alternativas terapéuticas disponibles en el CNMB vigente", "value": ""}, {"key": "3.5. Alternativas terapéuticas no presentes en el CNMB vigente", "value": ""} ] },
                { "section_number": "4", "title": "POLÍTICAS DE COBERTURA", "content_type": "coverage_policy_tables", "policies": { "title": "4.1 Políticas de cobertura", "headers": ["País/Agencia Sanitaria", "Indicación cubierta", "Fecha inicio cobertura (dd/mm/aaaa)"], "rows": [] }, "approvals": { "title": "4.2 Indicaciones formalmente aprobadas", "headers": ["Agencia sanitaria", "Indicación aprobada", "Tipo aprobación"], "rows": [] } },
                { "section_number": "5", "title": "BÚSQUEDA DE EVIDENCIA CIENTÍFICA", "content_type": "conamei_evidence_synthesis", "pico": {}, "search_strategy": [], "study_selection": { "studies": [] } },
                { "section_number": "6", "title": "DATOS DE EFICACIA Y SEGURIDAD", "content_type": "conamei_grade_and_safety_section", "grade_outcomes": [], "safety_details": {} },
                { "section_number": "7", "title": "DATOS ECONÓMICOS", "content_type": "conamei_economic_analysis", "cost_table": { "rows": [] }, "cost_analysis": {}, "pharmacoeconomic_summary": "" },
                { "section_number": "8", "title": "DATOS DE CONVENIENCIA", "content_type": "conamei_convenience_analysis", "parameters": [], "final_summary": "" },
                { "section_number": "9", "title": "CONCLUSIÓN DEL REVISOR", "content_type": "text", "text": null },
                { "section_number": "10", "title": "BIBLIOGRAFÍA", "content_type": "list", "items": [] },
                { "section_number": "11", "title": "FIRMA DE RESPONSABILIDAD", "content_type": "signature_block", "data": {"elaborator": "", "institution": "", "date": ""} },
                { "section_number": "13", "title": "MATRIZ 1: EVALUACIÓN INICIAL", "content_type": "automated_evaluation_matrix", "drug_info": { "dci": "", "form": "", "concentration": "", "indication": "", "comparator": "" }, "scoring": { "total_score": null, "decision": null }, "parameters": [
                    {"category": "EFICACIA", "question": "¿Cuál es la calidad de la evidencia científica?", "scale": ["Alta", "Moderada", "Baja o muy baja"], "result": null, "score": null, "justification": null},
                    {"category": "EFICACIA", "question": "¿Cuál es la fase de investigación clínica?", "scale": ["Fase IV+", "Fase III+", "Fase IV-", "Fase III-"], "result": null, "score": null, "justification": null},
                    {"category": "EFICACIA", "question": "¿Es un medicamento considerado como esencial por la OMS?", "scale": ["Si", "No"], "result": null, "score": null, "justification": null},
                    {"category": "EFICACIA", "question": "¿Mejora el desenlace final de la enfermedad?", "scale": ["Si", "No y/o se desconoce"], "result": null, "score": null, "justification": null},
                    {"category": "EFICACIA", "question": "¿La eficacia es superior, igual o inferior al comparador?", "scale": ["Superior", "No Inferior", "Inferior"], "result": null, "score": null, "justification": null},
                    {"category": "EFICACIA", "question": "¿Mejora la calidad de vida del paciente?", "scale": ["Si", "No y/o se desconoce"], "result": null, "score": null, "justification": null},
                    {"category": "SEGURIDAD", "question": "¿Puede provocar reacciones adversas letales o graves?", "scale": ["Poco frecuente", "Frecuente", "Muy frecuente"], "result": null, "score": null, "justification": null},
                    {"category": "SEGURIDAD", "question": "¿Es más seguro que las alternativas del CNMB?", "scale": ["Si", "No y/o se desconoce"], "result": null, "score": null, "justification": null},
                    {"category": "SEGURIDAD", "question": "¿Existen alertas sanitarias graves emitidas?", "scale": ["Si", "No"], "result": null, "score": null, "justification": null},
                    {"category": "PREVALENCIA / FRECUENCIA", "question": "¿La indicación tiene una prevalencia >5%?", "scale": ["Si", "No"], "result": null, "score": null, "justification": null},
                    {"category": "CONVENIENCIA", "question": "¿Existe una alternativa terapéutica dentro del CNMB?", "scale": ["Si", "No"], "result": null, "score": null, "justification": null},
                    {"category": "CONVENIENCIA", "question": "¿Mejora la adherencia y/o reduce la estancia hospitalaria?", "scale": ["Si", "No"], "result": null, "score": null, "justification": null},
                    {"category": "COSTO", "question": "¿El costo del tratamiento frente al comparador es menor, igual o mayor?", "scale": ["Menor", "Igual", "Mayor"], "result": null, "score": null, "justification": null}
                  ] }
              ]
            }
          }
        };

        function showStatus(message, isTemporary = false, duration = 3000) {
            statusEl.textContent = message;
            if (!isTemporary) {
                lastStatusMessage = message;
            } else {
                setTimeout(() => {
                    if (statusEl.textContent === message) {
                        statusEl.textContent = lastStatusMessage;
                    }
                }, duration);
            }
        }

        document.addEventListener('DOMContentLoaded', () => {
            const savedApiKey = localStorage.getItem(API_KEY_STORAGE_KEY);
            if (savedApiKey) {
                apiKeyInput.value = savedApiKey;
                showStatus('API Key cargada desde el almacenamiento local.', true);
            }
        });

        apiKeyInput.addEventListener('input', () => {
            localStorage.setItem(API_KEY_STORAGE_KEY, apiKeyInput.value);
        });
        
        clearApiKeyBtn.addEventListener('click', () => {
            localStorage.removeItem(API_KEY_STORAGE_KEY);
            apiKeyInput.value = '';
            showStatus('Clave de API borrada del almacenamiento local.', true);
        });

        async function handleGenerateClick() {
            const apiKey = apiKeyInput.value.trim();
            const dci = dciInput.value.trim();
            const indication = indicationInput.value.trim();

            if (!apiKey || !dci || !indication) {
                showStatus("Por favor, completa todos los campos: API Key, Medicamento e Indicación.");
                return;
            }

            generateBtn.disabled = true;
            loader.classList.remove('hidden');
            resultContainer.classList.add('hidden');
            showStatus('Buscando evidencia... (Esto puede tardar hasta un minuto)');

            try {
                const searcherPrompt = `
                    Actúa como un investigador médico experto y analista de HTA. Para el medicamento "${dci}" con la indicación principal de "${indication}", busca y sintetiza la siguiente información para un informe de CONAMEI. Tu respuesta DEBE ser un único objeto JSON.

                    {
                        "section2_data": { "atc_code": "...", "pharma_form": "...", "concentration": "...", "admin_route": "...", "commercial_presentation": "...", "sanitary_info": "..." },
                        "section3_data": { "mechanism_of_action": "...", "dosage_guideline": "...", "alternatives_cnmb": "...", "alternatives_not_cnmb": "..." },
                        "section4_data": { "policies": [{"country_agency": "...", "indication": "...", "date": "..."}], "approvals": [{"agency": "...", "indication": "...", "type": "..."}] },
                        "section5_data": { "pico_c": "...", "pivotal_trial_ref": "...", "pivotal_trial_synthesis": "..." },
                        "section6_data": {
                             "grade_outcomes": [{ "outcome_title": "...", "study_type_design": "...", "bias_risk": "...", "inconsistency": "...", "indirectness": "...", "imprecision": "...", "n_studies": "...", "n_patients": "...", "relative_effect": "...", "absolute_effect": "...", "importance": "Crítico" }],
                             "safety_details": { "details": "...", "has_alerts": "...", "alert_details": "...", "is_safer_than_cnmb": "...", "safety_justification": "..." }
                        },
                        "section7_data": { "cost_rows": [{ "parameter": "...", "intervention_value": "...", "comparator_value": "..." }], "is_cheaper": "...", "cost_justification": "...", "pharmacoeconomic_summary": "..." },
                        "section8_data": { "parameters": [{ "parameter": "...", "response": "...", "justification": "..." }], "final_summary": "..." },
                        "section10_data": { "references": ["..."] },
                        "matriz_data": { "quality_of_evidence": "...", "research_phase": "...", "who_essential": "...", "improves_outcome": "...", "efficacy_comparison": "...", "improves_qol": "...", "lethal_adverse_reactions": "...", "is_safer": "...", "has_safety_alerts": "...", "prevalence_over_5_percent": "...", "is_cnmb_alternative_available": "...", "improves_adherence_or_reduces_hospitalization": "...", "cost_comparison": "..." }
                    }
                `;

                const API_URL = `https://generativelanguage.googleapis.com/v1beta/models/gemini-1.5-flash-latest:generateContent?key=${apiKey}`;
                
                const response = await fetch(API_URL, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ contents: [{ parts: [{ text: searcherPrompt }] }] })
                });

                if (!response.ok) {
                    const errorData = await response.json();
                    throw new Error(`Error en la API: ${response.status} - ${errorData.error?.message || 'Respuesta de error desconocida'}`);
                }

                const data = await response.json();
                let evidenceText = data.candidates[0].content.parts[0].text;
                evidenceText = evidenceText.replace(/^```json\s*|```\s*$/g, '').trim();
                const evidence = JSON.parse(evidenceText);

                showStatus('Evidencia encontrada. Poblando plantilla completa...');
                const finalPrompt = buildFinalPrompt(dci, indication, evidence);

                resultTextarea.value = JSON.stringify(finalPrompt, null, 2);
                resultContainer.classList.remove('hidden');
                showStatus('¡Listo! El prompt JSON completo está preparado.');

            } catch (error) {
                console.error(error);
                let errorMessage = `Error: ${error.message}. Revisa la consola (F12) para más detalles.`;
                if (error.message.includes('API key not valid')) {
                    errorMessage = 'Error: La API Key no es válida. Por favor, verifica que sea correcta.';
                } else if (error instanceof SyntaxError) {
                    errorMessage = 'Error: La respuesta de la API no es un JSON válido. Inténtalo de nuevo.';
                }
                showStatus(errorMessage);
            } finally {
                generateBtn.disabled = false;
                loader.classList.add('hidden');
            }
        }

        function buildFinalPrompt(dci, indication, evidence) {
            let template = JSON.parse(JSON.stringify(finalPromptTemplate));
            const today = new Date();
            const formattedDate = `${today.getDate().toString().padStart(2, '0')}/${(today.getMonth() + 1).toString().padStart(2, '0')}/${today.getFullYear()}`;

            // --- Metadata ---
            template.report_content.report_metadata.report_id = `CONAMEI-${today.getFullYear()}-XX`;
            template.report_content.report_metadata.city_date = `Quito, D.M., ${formattedDate}`;

            // --- Section 1: Solicitante (Ejemplo) ---
            template.report_content.sections.find(s => s.section_number === "1").data.institution_name = "HOSPITAL DE ESPECIALIDADES";
            template.report_content.sections.find(s => s.section_number === "1").data.selected_rpis = "MSP";

            // --- Section 2: Medicamento ---
            let sec2 = template.report_content.sections.find(s => s.section_number === "2").data;
            sec2.find(d => d.key === "Código ATC").value = evidence.section2_data.atc_code;
            sec2.find(d => d.key === "DCI").value = dci;
            sec2.find(d => d.key === "Forma farmacéutica (CNMB)").value = evidence.section2_data.pharma_form;
            sec2.find(d => d.key === "Formas farmacéuticas (ARCSA)").value = evidence.section2_data.pharma_form;
            sec2.find(d => d.key === "Concentración").value = evidence.section2_data.concentration;
            sec2.find(d => d.key === "Vía de administración").value = evidence.section2_data.admin_route;
            sec2.find(d => d.key === "Presentación comercial").value = evidence.section2_data.commercial_presentation;
            sec2.find(d => d.key === "Información sanitaria").value = evidence.section2_data.sanitary_info;

            // --- Section 3: Indicación ---
            let sec3 = template.report_content.sections.find(s => s.section_number === "3").data;
            sec3.find(d => d.key.startsWith("3.1")).value = indication;
            sec3.find(d => d.key.startsWith("3.2")).value = evidence.section3_data.mechanism_of_action;
            sec3.find(d => d.key.startsWith("3.3")).value = evidence.section3_data.dosage_guideline;
            sec3.find(d => d.key.startsWith("3.4")).value = evidence.section3_data.alternatives_cnmb;
            sec3.find(d => d.key.startsWith("3.5")).value = evidence.section3_data.alternatives_not_cnmb;
            
            // --- Section 4: Cobertura ---
            let sec4 = template.report_content.sections.find(s => s.section_number === "4");
            sec4.policies.rows = evidence.section4_data.policies.map(p => [p.country_agency, p.indication, p.date]);
            sec4.approvals.rows = evidence.section4_data.approvals.map(a => [a.agency, a.indication, a.type]);

            // --- Section 5: Evidencia ---
            let sec5 = template.report_content.sections.find(s => s.section_number === "5");
            sec5.pico = { P: `Pacientes con ${indication}`, I: dci, C: evidence.section5_data.pico_c, O: "Eficacia, seguridad, etc." };
            sec5.study_selection.studies = [{ reference: evidence.section5_data.pivotal_trial_ref, synthesis: { study_summary: { summary_points: [{ description: evidence.section5_data.pivotal_trial_synthesis }] } } }];
            
            // --- Section 6: Eficacia y Seguridad ---
            let sec6 = template.report_content.sections.find(s => s.section_number === "6");
            sec6.grade_outcomes = evidence.section6_data.grade_outcomes;
            sec6.safety_details = evidence.section6_data.safety_details;

            // --- Section 7: Economía ---
            let sec7 = template.report_content.sections.find(s => s.section_number === "7");
            sec7.cost_table.rows = evidence.section7_data.cost_rows;
            sec7.cost_analysis = { is_cheaper: evidence.section7_data.is_cheaper, justification: evidence.section7_data.cost_justification };
            sec7.pharmacoeconomic_summary = evidence.section7_data.pharmacoeconomic_summary;

            // --- Section 8: Conveniencia ---
            let sec8 = template.report_content.sections.find(s => s.section_number === "8");
            sec8.parameters = evidence.section8_data.parameters;
            sec8.final_summary = evidence.section8_data.final_summary;

            // --- Section 10: Bibliografía ---
            template.report_content.sections.find(s => s.section_number === "10").items = evidence.section10_data.references;

            // --- Section 11: Firma ---
            let sec11 = template.report_content.sections.find(s => s.section_number === "11").data;
            sec11.elaborator = "Equipo Técnico CETSA";
            sec11.institution = "Comisión Nacional de Evaluación de Tecnologías Sanitarias";
            sec11.date = formattedDate;

            // --- Section 13: Matriz (Resultados para evaluación) ---
            let matrix = template.report_content.sections.find(s => s.section_number === "13");
            matrix.drug_info = { dci: dci, form: evidence.section2_data.pharma_form, concentration: evidence.section2_data.concentration, indication: indication, comparator: evidence.section5_data.pico_c };
            const matrizData = evidence.matriz_data;
            matrix.parameters.forEach(param => {
                if (param.question.includes("calidad de la evidencia")) param.result = matrizData.quality_of_evidence;
                if (param.question.includes("fase de investigación")) param.result = matrizData.research_phase;
                if (param.question.includes("esencial por la OMS")) param.result = matrizData.who_essential;
                if (param.question.includes("mejora el desenlace")) param.result = matrizData.improves_outcome;
                if (param.question.includes("eficacia es superior")) param.result = matrizData.efficacy_comparison;
                if (param.question.includes("mejora la calidad de vida")) param.result = matrizData.improves_qol;
                if (param.question.includes("reacciones adversas letales")) param.result = matrizData.lethal_adverse_reactions;
                if (param.question.includes("más seguro que las alternativas")) param.result = matrizData.is_safer;
                if (param.question.includes("alertas sanitarias")) param.result = matrizData.has_safety_alerts;
                if (param.question.includes("prevalencia >5%")) param.result = matrizData.prevalence_over_5_percent;
                if (param.question.includes("alternativa terapéutica dentro del CNMB")) param.result = matrizData.is_cnmb_alternative_available;
                if (param.question.includes("mejora la adherencia")) param.result = matrizData.improves_adherence_or_reduces_hospitalization;
                if (param.question.includes("costo del tratamiento")) param.result = matrizData.cost_comparison;
            });

            return template;
        }

        generateBtn.addEventListener('click', handleGenerateClick);
        
        copyBtn.addEventListener('click', () => { 
            resultTextarea.select(); 
            document.execCommand('copy'); 
            showStatus('¡Prompt JSON copiado al portapapeles!', true);
        });

        downloadBtn.addEventListener('click', () => { 
            const dciForFile = dciInput.value.trim().toLowerCase().replace(/\s+/g, '_') || 'prompt'; 
            const blob = new Blob([resultTextarea.value], { type: 'application/json' }); 
            const a = document.createElement('a'); 
            a.href = URL.createObjectURL(blob); 
            a.download = `prompt_${dciForFile}.json`; 
            document.body.appendChild(a); 
            a.click(); 
            document.body.removeChild(a); 
            showStatus('Archivo JSON de prompt descargado.', true);
        });
    </script>
</body>
</html>
