<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Generador de Informes CONAMEI Automatizado (Alta Fidelidad)</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <style>
        body { font-family: 'Inter', sans-serif; }
        .loader {
            border: 4px solid #f3f3f3;
            border-top: 4px solid #3498db;
            border-radius: 50%;
            width: 30px;
            height: 30px;
            animation: spin 1s linear infinite;
        }
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        .status-message { transition: opacity 0.5s ease-in-out; }
        #report-frame {
            width: 100%;
            height: 60vh;
            min-height: 500px;
            border: 1px solid #d1d5db;
            border-radius: 0.375rem;
        }
    </style>
</head>
<body class="bg-gray-100 p-4 sm:p-6 md:p-8">
    <div class="max-w-4xl mx-auto bg-white rounded-xl shadow-lg overflow-hidden">
        <div class="bg-gray-800 p-6">
            <h1 class="text-2xl font-bold text-white">Generador de Informes CONAMEI Automatizado</h1>
            <p class="text-gray-300 mt-1">Genera el informe HTML final en un solo clic con máxima fidelidad al formato oficial.</p>
        </div>

        <div class="p-6 md:p-8 space-y-6">
            <!-- API KEY INPUT -->
            <div>
                <label for="apiKey" class="block text-sm font-medium text-gray-700">Tu API Key de Google AI</label>
                <div class="mt-1 flex items-center space-x-2">
                    <input type="password" id="apiKey" class="block w-full rounded-md border-gray-300 shadow-sm focus:border-indigo-500 focus:ring-indigo-500 sm:text-sm" placeholder="Pega tu clave aquí (se guardará localmente)">
                    <button id="clearApiKeyBtn" class="rounded-md border border-gray-300 bg-white px-3 py-2 text-xs font-medium text-gray-700 shadow-sm hover:bg-gray-50">Borrar</button>
                </div>
            </div>

            <!-- DRUG & INDICATION INPUTS -->
            <div class="grid grid-cols-1 md:grid-cols-2 gap-6 border-t pt-6">
                <div>
                    <label for="dci" class="block text-sm font-medium text-gray-700">Nombre del Medicamento (DCI)</label>
                    <input type="text" id="dci" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-indigo-500 focus:ring-indigo-500 sm:text-sm" placeholder="Ej: Finerenona">
                </div>
                <div>
                    <label for="indication" class="block text-sm font-medium text-gray-700">Indicación Principal Solicitada</label>
                    <input type="text" id="indication" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-indigo-500 focus:ring-indigo-500 sm:text-sm" placeholder="Ej: Enfermedad renal crónica en pacientes con diabetes tipo 2">
                </div>
            </div>

            <!-- ACTION BUTTON & STATUS -->
            <div class="flex items-center space-x-4">
                <button id="generateBtn" class="inline-flex items-center rounded-md border border-transparent bg-indigo-600 px-4 py-2 text-sm font-medium text-white shadow-sm hover:bg-indigo-700 focus:outline-none focus:ring-2 focus:ring-indigo-500 focus:ring-offset-2">
                    Generar Informe Completo
                </button>
                <div id="loader" class="loader hidden"></div>
                <p id="status" class="text-sm text-gray-600 status-message"></p>
            </div>

            <!-- FINAL RESULT OUTPUT -->
            <div id="result-container" class="hidden border-t pt-6">
                <label for="report-frame" class="block text-sm font-bold text-green-700">Informe HTML Generado</label>
                <div class="mt-2">
                    <iframe id="report-frame" title="Informe Final"></iframe>
                </div>
                <textarea id="hidden-html-source" class="hidden"></textarea>
                <div class="mt-4 flex flex-wrap gap-3">
                    <button id="copyBtn" class="inline-flex items-center rounded-md border border-transparent bg-green-600 px-4 py-2 text-sm font-medium text-white shadow-sm hover:bg-green-700">
                        Copiar Código HTML
                    </button>
                    <button id="downloadBtn" class="inline-flex items-center rounded-md border border-gray-300 bg-white px-4 py-2 text-sm font-medium text-gray-700 shadow-sm hover:bg-gray-50">
                        Descargar como .html
                    </button>
                </div>
            </div>
        </div>
    </div>

<script>
    // --- DOM Elements ---
    const generateBtn = document.getElementById('generateBtn');
    const apiKeyInput = document.getElementById('apiKey');
    const clearApiKeyBtn = document.getElementById('clearApiKeyBtn');
    const dciInput = document.getElementById('dci');
    const indicationInput = document.getElementById('indication');
    const loader = document.getElementById('loader');
    const statusEl = document.getElementById('status');
    const resultContainer = document.getElementById('result-container');
    const reportFrame = document.getElementById('report-frame');
    const hiddenHtmlSource = document.getElementById('hidden-html-source');
    const copyBtn = document.getElementById('copyBtn');
    const downloadBtn = document.getElementById('downloadBtn');
    const API_KEY_STORAGE_KEY = 'CONAMEI_ASSISTANT_API_KEY';
    let lastStatusMessage = '';
    
    // --- Application Logic ---
    function showStatus(message, isTemporary = false, duration = 4000) {
        statusEl.textContent = message;
        if (!isTemporary) { lastStatusMessage = message; } 
        else { setTimeout(() => { if (statusEl.textContent === message) { statusEl.textContent = lastStatusMessage; } }, duration); }
    }

    document.addEventListener('DOMContentLoaded', () => {
        const savedApiKey = localStorage.getItem(API_KEY_STORAGE_KEY);
        if (savedApiKey) { apiKeyInput.value = savedApiKey; showStatus('API Key cargada.', true); }
    });

    apiKeyInput.addEventListener('input', () => localStorage.setItem(API_KEY_STORAGE_KEY, apiKeyInput.value));
    clearApiKeyBtn.addEventListener('click', () => { apiKeyInput.value = ''; localStorage.removeItem(API_KEY_STORAGE_KEY); showStatus('Clave de API borrada.', true); });

    // =========================================================================
    // ===                 ARQUITECTURA DEFINITIVA DE DOS PASOS              ===
    // =========================================================================

    /**
     * PASO 1: Prompt de Investigación (Refinado para el formato final).
     */
    function buildSearcherPrompt(dci, indication) {
        return `
            Actúa como un analista experto de HTA. Tu única tarea es investigar y rellenar este objeto JSON para "${dci}" usado en "${indication}".
            Sé exhaustivo y preciso. Busca datos de Ecuador si es posible. Si un dato no se encuentra, usa "No encontrado".
            Tu única salida debe ser el objeto JSON puro.

            {
                "drug_id": {
                    "atc_code": "Busca el código ATC", "dci": "${dci}", "pharma_form_cnmb": "Busca la forma farmacéutica general",
                    "pharma_form_arcsa": "Busca la forma farmacéutica específica aprobada", "concentration": "Busca las concentraciones comunes",
                    "admin_route": "Busca la vía de administración", "commercial_presentation": "Busca un nombre comercial y presentación",
                    "sanitary_info": "Busca aprobación de FDA o EMA"
                },
                "therapeutic_indication": {
                    "indication": "${indication}", "mechanism_of_action": "Describe el mecanismo de acción concisamente.",
                    "dosage_guideline": "Describe la pauta de dosificación estándar.", "alternatives_cnmb": "Busca alternativas en el CNMB de Ecuador",
                    "alternatives_not_cnmb": "Busca otras alternativas relevantes no en el CNMB"
                },
                "coverage": {
                    "policies": [
                        {"agency": "Busca agencia 1 (ej. NICE)", "indication": "Busca indicación cubierta", "date": "Busca fecha (dd/mm/aaaa)"},
                        {"agency": "Busca agencia 2 (ej. CADTH)", "indication": "Busca indicación cubierta", "date": "Busca fecha (dd/mm/aaaa)"}
                    ],
                    "approvals": [
                        {"agency": "Busca agencia 1 (ej. EMA)", "indication": "Busca indicación aprobada", "type": "Busca tipo de aprobación", "date": "Busca fecha (dd/mm/aaaa)"},
                        {"agency": "Busca agencia 2 (ej. FDA)", "indication": "Busca indicación aprobada", "type": "Busca tipo de aprobación", "date": "Busca fecha (dd/mm/aaaa)"}
                    ]
                },
                "pico": { "p": "${indication}", "i": "${dci}", "c": "Busca el comparador relevante", "o": "Busca los desenlaces primarios de los estudios pivotales" },
                "pivotal_study": {
                    "reference": "Encuentra la referencia del estudio pivotal", "study_type": "Tipo de estudio",
                    "evidence_level": "Nivel de evidencia (ej. 1a)", "recommendation_grade": "Grado de recomendación (ej. A)",
                    "synthesis": "Resume en 2-3 frases los hallazgos clave del estudio."
                },
                "grade_summary": [
                    { "outcome": "Busca el desenlace primario principal", "design": "1 ECA (N=...)", "risk_of_bias": "No serio", "inconsistency": "No serio", "indirectness": "No serio", "imprecision": "No serio", "other": "Ninguna", "relative_effect": "Busca el HR/RR (IC 95%)", "absolute_effect": "Busca el efecto absoluto por 1000", "certainty": "Alta" },
                    { "outcome": "Busca un desenlace secundario clave (ej. Mortalidad)", "design": "1 ECA (N=...)", "risk_of_bias": "No serio", "inconsistency": "No serio", "indirectness": "No serio", "imprecision": "No serio", "other": "Ninguna", "relative_effect": "Busca el HR/RR (IC 95%)", "absolute_effect": "Busca el efecto absoluto por 1000", "certainty": "Alta" }
                ],
                "safety_details": {
                    "adverse_reactions": "Resume las reacciones adversas frecuentes y graves.",
                    "has_alerts": "Indica si existen alertas de seguridad graves (Si/No)",
                    "alerts_details": "Si existen alertas, descríbelas.",
                    "is_safer": "Compara la seguridad con las alternativas del CNMB (Si/No/Diferente)",
                    "safety_justification": "Justifica brevemente la comparación de seguridad."
                },
                "economic_data": {
                    "unit_price": "Busca el precio unitario en USD (SERCOP Ecuador si es posible, si no, un proxy internacional)", "posology": "Describe la posología anual", "annual_cost": "Calcula el costo anual por paciente",
                    "cost_analysis_justification": "Compara el costo con alternativas y justifica.", "pharmacoeconomic_summary": "Resume un estudio farmacoeconómico (ej. de NICE)"
                },
                "convenience_data": {
                    "frequency": "Compara la frecuencia de administración (Si/No menor)", "adherence": "Evalúa si mejora la adherencia (Si/No)", "hospitalization": "Evalúa si reduce hospitalización (Si/No)",
                    "frequency_justification": "Justifica la frecuencia.", "adherence_justification": "Justifica la adherencia.", "hospitalization_justification": "Justifica la hospitalización."
                },
                "matrix_evaluation": {
                    "calidad_evidencia": "Evalúa (Alta, Moderada, Baja)", "fase_investigacion": "Identifica (Fase IV+, Fase III+)",
                    "oms_esencial": "Indica (Si/No)", "mejora_desenlace": "Indica (Si/No)",
                    "eficacia_comparador": "Compara (Superior, No Inferior, Inferior)", "mejora_qol": "Indica (Si/No/No encontrado)",
                    "reacciones_graves": "Clasifica (Poco frecuente, Frecuente)", "mas_seguro_cnmb": "Compara (Si/No/Diferente)",
                    "alertas_sanitarias": "Indica (Si/No)", "prevalencia_ecuador": "Estima (Si/No >5%)",
                    "existe_alternativa_cnmb": "Confirma (Si/No)", "mejora_adherencia": "Evalúa (Si/No)", "costo_comparador": "Estima (Menor, Igual, Mayor)"
                },
                "bibliography": ["Busca la referencia del estudio pivotal principal", "Busca la referencia de un segundo estudio pivotal", "Busca una revisión sistemática o metaanálisis reciente"]
            }
        `;
    }
    
    /**
     * PLANTILLA HTML LITERAL Y COMPLETA, BASADA EN informedpa.html
     */
    const HTML_TEMPLATE = `
    <!DOCTYPE html>
    <html lang="es">
    <head>
        <meta charset="UTF-8">
        <title>Informe T&eacute;cnico CONAMEI</title>
        <style>
            body { font-family: Calibri, Arial, sans-serif; font-size: 11pt; margin: 0; background-color: #eee; }
            .page { width: 210mm; min-height: 297mm; padding: 1.5cm; margin: 1cm auto; border: 1px #D3D3D3 solid; background: white; box-shadow: 0 0 5px rgba(0, 0, 0, 0.1); box-sizing: border-box; }
            table { width: 100%; border-collapse: collapse; margin-bottom: 10px; font-size: 9pt; }
            th, td { border: 1px solid black; padding: 4px 6px; text-align: left; vertical-align: top; }
            th { background-color: #E7E6E6; font-weight: bold; }
            .main-title { text-align: center; font-weight: bold; font-size: 10pt; }
            .header-img, .footer-img { width: 100%; display: block; }
            .section-title { font-weight: bold; font-size: 10pt; }
            .sub-section-title { font-weight: bold; font-size: 9pt; margin-top: 10px; }
            .page-break { page-break-after: always; }
            ul { padding-left: 20px; margin: 5px 0; }
            li { margin-bottom: 5px; font-size: 9pt; }
            p { margin: 5px 0; font-size: 9pt; }
            .bold { font-weight: bold; }
        </style>
    </head>
    <body>
        <div class="page">
            <img src="https://i.imgur.com/uT2F8QG.png" alt="Encabezado CONAMEI" class="header-img">
            <p style="text-align: right; font-size: 10pt;">{{city_date}}</p>
            <p class="main-title">INFORME T&Eacute;CNICO Nro. {{report_id}}</p>
            
            <p class="section-title">1. IDENTIFICACI&Oacute;N DEL MEDICAMENTO</p>
            <table>
                <tr><th style="width:30%;">C&oacute;digo ATC</th><td>{{drug_id.atc_code}}</td></tr>
                <tr><th>DCI</th><td>{{drug_id.dci}}</td></tr>
                <tr><th>Forma farmac&eacute;utica (CNMB)</th><td>{{drug_id.pharma_form_cnmb}}</td></tr>
                <tr><th>Formas farmac&eacute;uticas (ARCSA)</th><td>{{drug_id.pharma_form_arcsa}}</td></tr>
                <tr><th>Concentraci&oacute;n</th><td>{{drug_id.concentration}}</td></tr>
                <tr><th>V&iacute;a de administraci&oacute;n</th><td>{{drug_id.admin_route}}</td></tr>
                <tr><th>Presentaci&oacute;n comercial</th><td>{{drug_id.commercial_presentation}}</td></tr>
                <tr><th>Informaci&oacute;n sanitaria</th><td>{{drug_id.sanitary_info}}</td></tr>
            </table>

            <p class="section-title">2. INDICACI&Oacute;N TERAP&Eacute;UTICA</p>
            <table>
                <tr><th style="width:30%;">2.1. Indicaci&oacute;n terap&eacute;utica</th><td>{{therapeutic_indication.indication}}</td></tr>
                <tr><th>2.2. Mecanismo de acci&oacute;n</th><td>{{therapeutic_indication.mechanism_of_action}}</td></tr>
                <tr><th>2.3. Pauta de dosificaci&oacute;n</th><td>{{therapeutic_indication.dosage_guideline}}</td></tr>
                <tr><th>2.4. Alternativas en CNMB</th><td>{{therapeutic_indication.alternatives_cnmb}}</td></tr>
                <tr><th>2.5. Alternativas no en CNMB</th><td>{{therapeutic_indication.alternatives_not_cnmb}}</td></tr>
            </table>

            <p class="section-title">3. POL&Iacute;TICAS DE COBERTURA</p>
            <p class="sub-section-title">3.1. Pol&iacute;ticas de cobertura</p>
            <table><thead><tr><th>Pa&iacute;s/Agencia Sanitaria</th><th>Indicaci&oacute;n cubierta</th><th>Fecha</th></tr></thead><tbody>{{policies_rows}}</tbody></table>
            <p class="sub-section-title">3.2. Indicaciones formalmente aprobadas</p>
            <table><thead><tr><th>Agencia sanitaria</th><th>Indicaci&oacute;n aprobada</th><th>Tipo</th><th>Fecha</th></tr></thead><tbody>{{approvals_rows}}</tbody></table>

            <div class="page-break"></div>

            <p class="section-title">5. B&Uacute;SQUEDA DE EVIDENCIA CIENT&Iacute;FICA</p>
            <p class="sub-section-title">Pregunta PICO</p>
            <table>
                <tr><th style="width:10%;">P</th><td>{{pico.p}}</td></tr>
                <tr><th>I</th><td>{{pico.i}}</td></tr>
                <tr><th>C</th><td>{{pico.c}}</td></tr>
                <tr><th>O</th><td>{{pico.o}}</td></tr>
            </table>
            
            <p class="sub-section-title">Estudio Pivotal</p>
            <table>
                <tr><th style="width:25%;">Referencia</th><td>{{pivotal_study.reference}}</td></tr>
                <tr><th>Tipo de Estudio</th><td>{{pivotal_study.study_type}}</td></tr>
                <tr><th>Nivel / Grado</th><td>{{pivotal_study.evidence_level}} / {{pivotal_study.recommendation_grade}}</td></tr>
                <tr><th>S&iacute;ntesis</th><td>{{pivotal_study.synthesis}}</td></tr>
            </table>

            <p class="section-title">6. DATOS DE EFICACIA Y SEGURIDAD</p>
            <p class="sub-section-title">Tabla de Resumen de Hallazgos (Formato GRADE)</p>
            {{grade_tables}}
            <p class="sub-section-title">Datos de seguridad</p>
            <table>
                <tr><th>Detalle de reacciones adversas</th><td>{{safety_details.adverse_reactions}}</td></tr>
                <tr><th>&iquest;Alertas sanitarias graves?</th><td>{{safety_details.has_alerts}}. {{safety_details.alerts_details}}</td></tr>
                <tr><th>&iquest;M&aacute;s seguro que alternativas CNMB?</th><td>{{safety_details.is_safer}}. {{safety_details.safety_justification}}</td></tr>
            </table>

            <p class="section-title">7. DATOS ECON&Oacute;MICOS</p>
            <table>
                <tr><th style="width:30%;">Precio unitario</th><td>{{economic_data.unit_price}}</td></tr>
                <tr><th>Posolog&iacute;a</th><td>{{economic_data.posology}}</td></tr>
                <tr><th>Costo anual por paciente</th><td>{{economic_data.annual_cost}}</td></tr>
                <tr><th>An&aacute;lisis de costos</th><td>{{economic_data.cost_analysis_justification}}</td></tr>
                <tr><th>Resumen farmacoecon&oacute;mico</th><td>{{economic_data.pharmacoeconomic_summary}}</td></tr>
            </table>

            <p class="section-title">8. DATOS DE CONVENIENCIA</p>
            <table>
                <tr><th style="width:30%;">&iquest;Frecuencia de administraci&oacute;n menor?</th><td>{{convenience_data.frequency}} - {{convenience_data.frequency_justification}}</td></tr>
                <tr><th>&iquest;Mejora la adherencia?</th><td>{{convenience_data.adherence}} - {{convenience_data.adherence_justification}}</td></tr>
                <tr><th>&iquest;Disminuye hospitalizaci&oacute;n?</th><td>{{convenience_data.hospitalization}} - {{convenience_data.hospitalization_justification}}</td></tr>
            </table>
            
            <p class="section-title">9. CONCLUSI&Oacute;N DEL REVISOR</p>
            <p>{{conclusion_text}}</p>

            <p class="section-title">10. BIBLIOGRAF&Iacute;A</p>
            <ul>{{bibliography_items}}</ul>

            <div class="page-break"></div>
            
            <p class="section-title">13. MATRIZ 1: EVALUACI&Oacute;N INICIAL</p>
            <table>
                <thead><tr><th style="width:15%">Categor&iacute;a</th><th>Pregunta</th><th style="width:15%">Resultado</th><th style="width:10%">Puntaje</th><th>Justificaci&oacute;n</th></tr></thead>
                <tbody>{{matrix_rows}}</tbody>
                <tfoot>
                    <tr><td colspan="3" style="text-align:right; font-weight:bold;">PUNTAJE TOTAL</td><td><strong>{{total_score}}</strong></td><td></td></tr>
                    <tr><td colspan="3" style="text-align:right; font-weight:bold;">DECISI&Oacute;N</td><td colspan="2"><strong>{{decision}}</strong></td></tr>
                </tfoot>
            </table>
            <img src="https://i.imgur.com/5b8tB3B.png" alt="Pie de página CONAMEI" class="footer-img" style="margin-top: 50px;">
        </div>
    </body>
    </html>
    `;

    /**
     * WORKFLOW PRINCIPAL
     */
    async function handleGenerateClick() {
        const apiKey = apiKeyInput.value.trim();
        const dci = dciInput.value.trim();
        const indication = indicationInput.value.trim();
        if (!apiKey || !dci || !indication) { showStatus("ERROR: Completa todos los campos."); return; }

        generateBtn.disabled = true;
        loader.classList.remove('hidden');
        resultContainer.classList.add('hidden');
        
        const API_URL = `https://generativelanguage.googleapis.com/v1beta/models/gemini-1.5-pro-latest:generateContent?key=${apiKey}`;

        try {
            // --- PASO 1: RECOPILAR EVIDENCIA ---
            showStatus('Paso 1/2: Recopilando evidencia m&eacute;dica...');
            const searcherPrompt = buildSearcherPrompt(dci, indication);
            const searchResponse = await fetch(API_URL, {
                method: 'POST', headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ contents: [{ parts: [{ text: searcherPrompt }] }] })
            });
            if (!searchResponse.ok) throw new Error(`Error en API (Paso 1): ${searchResponse.status}`);
            const searchData = await searchResponse.json();
            const evidenceText = searchData.candidates[0].content.parts[0].text.replace(/^```json\s*|```\s*$/g, '').trim();
            const evidence = JSON.parse(evidenceText);
            
            // --- PASO 2: RENDERIZADO Y EVALUACIÓN (LÓGICA LOCAL) ---
            showStatus('Paso 2/2: Ensamblando el informe HTML...');
            
            const matrixData = evidence.matrix_evaluation;
            let totalScore = 0;
            
            const matrixQuestions = [
                { key: 'calidad_evidencia', category: 'EFICACIA', question: '¿Cuál es la calidad de la evidencia científica?' }, { key: 'fase_investigacion', category: 'EFICACIA', question: '¿Cuál es la fase de investigación clínica?' },
                { key: 'oms_esencial', category: 'EFICACIA', question: '¿Es un medicamento considerado como esencial por la OMS?' }, { key: 'mejora_desenlace', category: 'EFICACIA', question: '¿Mejora el desenlace final de la enfermedad?' },
                { key: 'eficacia_comparador', category: 'EFICACIA', question: '¿La eficacia es superior, igual o inferior al comparador?' }, { key: 'mejora_qol', category: 'EFICACIA', question: '¿Mejora la calidad de vida del paciente?' },
                { key: 'reacciones_graves', category: 'SEGURIDAD', question: '¿Puede provocar reacciones adversas letales o graves?' }, { key: 'mas_seguro_cnmb', category: 'SEGURIDAD', question: '¿Es más seguro que las alternativas del CNMB?' },
                { key: 'alertas_sanitarias', category: 'SEGURIDAD', question: '¿Existen alertas sanitarias graves emitidas?' }, { key: 'prevalencia_ecuador', category: 'PREVALENCIA', question: '¿La indicación tiene una prevalencia >5%?' },
                { key: 'existe_alternativa_cnmb', category: 'CONVENIENCIA', question: '¿Existe una alternativa terapéutica dentro del CNMB?' }, { key: 'mejora_adherencia', category: 'CONVENIENCIA', question: '¿Mejora la adherencia y/o reduce la estancia hospitalaria?' },
                { key: 'costo_comparador', category: 'COSTO', question: '¿El costo del tratamiento frente al comparador es menor, igual o mayor?' }
            ];

            let matrixRowsHtml = '';
            for (const item of matrixQuestions) {
                const result = matrixData[item.key] || "No encontrado";
                let score = 0;
                const scoringRules = { "Alta": 2, "Moderada": 1, "Baja": 0, "Baja o muy baja": 0, "Fase IV+": 2, "Fase III+": 1, "Fase IV-": 0, "Fase III-": -1, "Superior": 1, "No Inferior": 0, "Inferior": -1, "Poco frecuente": 0, "Frecuente": -1, "Muy frecuente": -2, "Menor": 1, "Igual": 0, "Mayor": -1 };
                if (['oms_esencial', 'mejora_desenlace', 'mejora_qol', 'prevalencia_ecuador', 'mejora_adherencia'].includes(item.key)) { score = (result === 'Si') ? 1 : 0; }
                else if (item.key === 'alertas_sanitarias') { score = (result === 'Si') ? -1 : 1; } 
                else if (item.key === 'existe_alternativa_cnmb') { score = (result === 'Si') ? 0 : 1; }
                else if (item.key === 'mas_seguro_cnmb') { score = (result === 'Si') ? 1 : 0; }
                else { score = scoringRules[result] ?? 0; }
                totalScore += score;
                matrixRowsHtml += `<tr><td>${item.category}</td><td>${item.question}</td><td>${result}</td><td>${score}</td><td>Basado en evidencia de estudios pivotales.</td></tr>`;
            }

            const decisionThreshold = 7;
            const decision = totalScore >= decisionThreshold ? "PASA A SEGUNDA ETAPA" : "NO PASA ETAPA";
            
            let conclusionText = (decision === "PASA A SEGUNDA ETAPA") ?
                `Considerando la carga de la ${indication.toLowerCase()} en Ecuador, la evidencia presentada para ${dci} demuestra un perfil favorable. El balance beneficio/riesgo es positivo. Con un puntaje total de ${totalScore}, que cumple o supera el umbral requerido, se concluye que la tecnología sanitaria presenta méritos suficientes para una evaluación más profunda. **Recomendación:** Se recomienda que ${dci} **PASE A LA SEGUNDA ETAPA** de evaluación.` :
                `Si bien ${dci} ha demostrado beneficios en los estudios pivotales, el análisis global de la matriz no respalda su avance. Con un puntaje total de ${totalScore}, que no alcanza el umbral requerido de ${decisionThreshold}, la propuesta de valor para su inclusión en el CNMB no es clara frente a las alternativas existentes. **Recomendación:** Se recomienda que ${dci} **NO PASE A LA SEGUNDA ETAPA** de evaluación.`;
            
            const renderTableRows = (data, keys) => (data || []).map(row => `<tr>${keys.map(key => `<td>${row[key] || 'No encontrado'}</td>`).join('')}</tr>`).join('');
            
            const policiesRows = renderTableRows(evidence.coverage.policies, ['agency', 'indication', 'date']);
            const approvalsRows = renderTableRows(evidence.coverage.approvals, ['agency', 'indication', 'type', 'date']);
            let gradeTablesHtml = '';
            if (evidence.grade_summary) {
                evidence.grade_summary.forEach(grade => {
                    gradeTablesHtml += `
                        <p class="sub-section-title">${grade.outcome}</p>
                        <table style="font-size: 8pt;">
                            <thead><tr><th>Diseño</th><th>Riesgo Sesgo</th><th>Incons.</th><th>Indirec.</th><th>Imprec.</th><th>Otras</th><th>Efecto Relativo</th><th>Efecto Absoluto</th><th>Certeza</th></tr></thead>
                            <tbody><tr><td>${grade.design}</td><td>${grade.risk_of_bias}</td><td>${grade.inconsistency}</td><td>${grade.indirectness}</td><td>${grade.imprecision}</td><td>${grade.other}</td><td>${grade.relative_effect}</td><td>${grade.absolute_effect}</td><td class="bold">${grade.certainty}</td></tr></tbody>
                        </table>`;
                });
            }

            const getValue = (obj, path) => path.split('.').reduce((acc, part) => acc && acc[part], obj) || 'No encontrado';
            let finalHtml = HTML_TEMPLATE
                .replace('{{report_id}}', `CONAMEI-2024-${Math.floor(Math.random() * 90 + 10)}`)
                .replace('{{city_date}}', new Date().toLocaleDateString('es-ES', { day: '2-digit', month: 'long', year: 'numeric' }))
                .replace('{{applicant.institution_name}}', getValue(evidence, 'applicant.institution_name'))
                .replace('{{drug_id.atc_code}}', getValue(evidence, 'drug_id.atc_code'))
                .replace('{{drug_id.dci}}', getValue(evidence, 'drug_id.dci'))
                .replace('{{drug_id.pharma_form_cnmb}}', getValue(evidence, 'drug_id.pharma_form_cnmb'))
                .replace('{{drug_id.pharma_form_arcsa}}', getValue(evidence, 'drug_id.pharma_form_arcsa'))
                .replace('{{drug_id.concentration}}', getValue(evidence, 'drug_id.concentration'))
                .replace('{{drug_id.admin_route}}', getValue(evidence, 'drug_id.admin_route'))
                .replace('{{drug_id.commercial_presentation}}', getValue(evidence, 'drug_id.commercial_presentation'))
                .replace('{{drug_id.sanitary_info}}', getValue(evidence, 'drug_id.sanitary_info'))
                .replace('{{therapeutic_indication.indication}}', getValue(evidence, 'therapeutic_indication.indication'))
                .replace('{{therapeutic_indication.mechanism_of_action}}', getValue(evidence, 'therapeutic_indication.mechanism_of_action'))
                .replace('{{therapeutic_indication.dosage_guideline}}', getValue(evidence, 'therapeutic_indication.dosage_guideline'))
                .replace('{{therapeutic_indication.alternatives_cnmb}}', getValue(evidence, 'therapeutic_indication.alternatives_cnmb'))
                .replace('{{therapeutic_indication.alternatives_not_cnmb}}', getValue(evidence, 'therapeutic_indication.alternatives_not_cnmb'))
                .replace('{{policies_rows}}', policiesRows)
                .replace('{{approvals_rows}}', approvalsRows)
                .replace('{{pico.p}}', getValue(evidence, 'pico.p'))
                .replace('{{pico.i}}', getValue(evidence, 'pico.i'))
                .replace('{{pico.c}}', getValue(evidence, 'pico.c'))
                .replace('{{pico.o}}', getValue(evidence, 'pico.o'))
                .replace('{{pivotal_study.reference}}', getValue(evidence, 'pivotal_study.reference'))
                .replace('{{pivotal_study.study_type}}', getValue(evidence, 'pivotal_study.study_type'))
                .replace('{{pivotal_study.evidence_level}}', getValue(evidence, 'pivotal_study.evidence_level'))
                .replace('{{pivotal_study.recommendation_grade}}', getValue(evidence, 'pivotal_study.recommendation_grade'))
                .replace('{{pivotal_study.synthesis}}', getValue(evidence, 'pivotal_study.synthesis'))
                .replace('{{grade_tables}}', gradeTablesHtml)
                .replace('{{safety_details.adverse_reactions}}', getValue(evidence, 'safety_details.adverse_reactions'))
                .replace('{{safety_details.has_alerts}}', getValue(evidence, 'safety_details.has_alerts'))
                .replace('{{safety_details.alerts_details}}', getValue(evidence, 'safety_details.alerts_details'))
                .replace('{{safety_details.is_safer}}', getValue(evidence, 'safety_details.is_safer'))
                .replace('{{safety_details.safety_justification}}', getValue(evidence, 'safety_details.safety_justification'))
                .replace('{{economic_data.unit_price}}', getValue(evidence, 'economic_data.unit_price'))
                .replace('{{economic_data.posology}}', getValue(evidence, 'economic_data.posology'))
                .replace('{{economic_data.annual_cost}}', getValue(evidence, 'economic_data.annual_cost'))
                .replace('{{economic_data.cost_analysis_justification}}', getValue(evidence, 'economic_data.cost_analysis_justification'))
                .replace('{{economic_data.pharmacoeconomic_summary}}', getValue(evidence, 'economic_data.pharmacoeconomic_summary'))
                .replace('{{convenience_data.frequency}}', getValue(evidence, 'convenience_data.frequency'))
                .replace('{{convenience_data.adherence}}', getValue(evidence, 'convenience_data.adherence'))
                .replace('{{convenience_data.hospitalization}}', getValue(evidence, 'convenience_data.hospitalization'))
                .replace('{{convenience_data.frequency_justification}}', getValue(evidence, 'convenience_data.frequency_justification'))
                .replace('{{convenience_data.adherence_justification}}', getValue(evidence, 'convenience_data.adherence_justification'))
                .replace('{{convenience_data.hospitalization_justification}}', getValue(evidence, 'convenience_data.hospitalization_justification'))
                .replace('{{conclusion_text}}', conclusionText)
                .replace('{{bibliography_items}}', (evidence.bibliography || []).map(item => `<li>${item}</li>`).join(''))
                .replace('{{matrix_rows}}', matrixRowsHtml)
                .replace('{{total_score}}', totalScore)
                .replace('{{decision}}', decision);

            // --- MOSTRAR RESULTADO ---
            hiddenHtmlSource.value = finalHtml;
            reportFrame.srcdoc = finalHtml;
            resultContainer.classList.remove('hidden');
            showStatus('¡Informe completo generado con éxito!');

        } catch (error) {
            console.error("Error detallado:", error);
            let errorMessage = `Error: ${error.message}. Revisa la consola (F12) para más detalles.`;
            if (error.message.includes('API key not valid')) {
                errorMessage = 'Error: La API Key no es válida o no tiene permisos para este modelo (prueba gemini-1.5-pro).';
            } else if (error instanceof SyntaxError) {
                errorMessage = 'Error: La respuesta de la API no era un JSON válido. Esto puede ser un error temporal del modelo. Inténtalo de nuevo.';
            }
            showStatus(errorMessage);
        } finally {
            generateBtn.disabled = false;
            loader.classList.add('hidden');
        }
    }
    
    // --- Button Event Listeners ---
    generateBtn.addEventListener('click', handleGenerateClick);
    copyBtn.addEventListener('click', () => { navigator.clipboard.writeText(hiddenHtmlSource.value); showStatus('¡Código HTML copiado!', true, 3000); });
    downloadBtn.addEventListener('click', () => { 
        const blob = new Blob([hiddenHtmlSource.value], { type: 'text/html' }); 
        const a = document.createElement('a'); 
        a.href = URL.createObjectURL(blob); 
        a.download = `informe_conamei_${dciInput.value.trim().toLowerCase() || 'informe'}.html`; 
        a.click();
        showStatus('Informe HTML descargado.', true, 3000);
    });
</script>

</body>
</html>
