<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Generador de Informes CONAMEI (Alta Fidelidad)</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/lodash@4.17.21/lodash.min.js"></script>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <style>
        body { font-family: 'Inter', sans-serif; }
        .loader {
            display: inline-block;
            border: 4px solid #f3f3f3;
            border-top: 4px solid #3498db;
            border-radius: 50%;
            width: 24px;
            height: 24px;
            animation: spin 1s linear infinite;
        }
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
    </style>
</head>
<body class="bg-gray-100 p-4 sm:p-6 md:p-8">
    <div class="max-w-7xl mx-auto bg-white rounded-xl shadow-lg overflow-hidden">
        <div class="bg-gray-800 p-6">
            <h1 class="text-2xl font-bold text-white">Generador de Informes CONAMEI (Alta Fidelidad)</h1>
            <p class="text-gray-300 mt-1">Herramienta para generar informes técnicos sección por sección, basado en el formato oficial.</p>
        </div>

        <div class="p-6 md:p-8">
            <div class="grid grid-cols-1 lg:grid-cols-3 gap-8">
                <!-- Columna de Controles -->
                <div class="lg:col-span-1 space-y-6">
                    <div class="space-y-4 p-4 border rounded-lg">
                        <h3 class="font-semibold text-lg text-gray-800">Panel de Control</h3>
                        <div>
                            <label for="apiKey" class="block text-sm font-medium text-gray-700">1. API Key de Google AI</label>
                            <div class="mt-1 flex items-center space-x-2">
                                <input type="password" id="apiKey" class="block w-full rounded-md border-gray-300 shadow-sm focus:border-indigo-500 focus:ring-indigo-500 sm:text-sm" placeholder="Pega tu clave aquí">
                                <button id="clearApiKeyBtn" class="rounded-md border border-gray-300 bg-white px-3 py-2 text-xs font-medium text-gray-700 shadow-sm hover:bg-gray-50" title="Borrar Clave">X</button>
                            </div>
                        </div>
                        <div>
                            <label for="dci" class="block text-sm font-medium text-gray-700">2. Datos del Medicamento</label>
                            <div class="mt-1 space-y-2">
                                <input type="text" id="dci" class="block w-full rounded-md border-gray-300 shadow-sm sm:text-sm" placeholder="Nombre del Medicamento (DCI)">
                                <input type="text" id="indication" class="block w-full rounded-md border-gray-300 shadow-sm sm:text-sm" placeholder="Indicación Solicitada">
                            </div>
                        </div>
                    </div>

                    <div class="space-y-4 p-4 border rounded-lg">
                        <div class="flex justify-between items-center">
                            <h3 class="font-semibold text-lg text-gray-800">3. Proceso de Generación</h3>
                            <div id="loader" class="loader hidden"></div>
                        </div>
                        <p class="text-sm text-gray-600">Completa los datos y luego genera el informe sección por sección.</p>
                        <div id="section-buttons" class="space-y-2 pt-2 border-t">
                            <button id="btn-sec12" data-section="12" class="gen-btn w-full text-white bg-indigo-600 hover:bg-indigo-700 font-medium rounded-lg text-sm px-5 py-2.5 text-center disabled:bg-gray-400">1. Identificación e Indicación</button>
                            <button id="btn-sec3" data-section="3" class="gen-btn w-full text-white bg-indigo-600 hover:bg-indigo-700 font-medium rounded-lg text-sm px-5 py-2.5 text-center disabled:bg-gray-400" disabled>2. Políticas de Cobertura</button>
                            <button id="btn-sec4" data-section="4" class="gen-btn w-full text-white bg-indigo-600 hover:bg-indigo-700 font-medium rounded-lg text-sm px-5 py-2.5 text-center disabled:bg-gray-400" disabled>3. Búsqueda de Evidencia</button>
                            <button id="btn-sec5" data-section="5" class="gen-btn w-full text-white bg-indigo-600 hover:bg-indigo-700 font-medium rounded-lg text-sm px-5 py-2.5 text-center disabled:bg-gray-400" disabled>4. Eficacia y Seguridad</button>
                            <button id="btn-sec6" data-section="6" class="gen-btn w-full text-white bg-indigo-600 hover:bg-indigo-700 font-medium rounded-lg text-sm px-5 py-2.5 text-center disabled:bg-gray-400" disabled>5. Datos Económicos</button>
                            <button id="btn-sec7" data-section="7" class="gen-btn w-full text-white bg-indigo-600 hover:bg-indigo-700 font-medium rounded-lg text-sm px-5 py-2.5 text-center disabled:bg-gray-400" disabled>6. Datos de Conveniencia y Bibliografía</button>
                            <button id="btn-sec8" data-section="8" class="gen-btn w-full text-white bg-blue-500 hover:bg-blue-600 font-medium rounded-lg text-sm px-5 py-2.5 text-center disabled:bg-gray-400" disabled>7. Generar Conclusión</button>
                        </div>
                    </div>

                    <div id="status-container" class="p-4 border rounded-lg bg-gray-50 min-h-[60px]">
                         <p id="status" class="text-sm text-gray-600 status-message text-center">Esperando para iniciar...</p>
                    </div>

                    <div id="final-actions" class="hidden p-4 border rounded-lg space-y-3">
                         <h3 class="text-lg font-bold text-green-700 text-center">¡Informe Completo!</h3>
                         <button id="copyBtn" class="w-full inline-flex justify-center items-center rounded-md border border-transparent bg-green-600 px-4 py-2 text-sm font-medium text-white shadow-sm hover:bg-green-700">Copiar Código HTML</button>
                         <button id="downloadBtn" class="w-full inline-flex justify-center items-center rounded-md border border-gray-300 bg-white px-4 py-2 text-sm font-medium text-gray-700 shadow-sm hover:bg-gray-50">Descargar .html</button>
                         <textarea id="hidden-html-source" class="hidden"></textarea>
                    </div>
                </div>

                <div class="lg:col-span-2">
                    <div class="h-full w-full rounded-lg border-2 border-dashed border-gray-200 bg-gray-50 p-2">
                        <iframe id="report-frame" title="Vista Previa del Informe" class="w-full h-full min-h-[80vh]"></iframe>
                    </div>
                </div>
            </div>
        </div>
    </div>
<script>
document.addEventListener('DOMContentLoaded', () => {
    // --- STATE MANAGEMENT ---
    const appState = {
        apiKey: '',
        dci: '',
        indication: '',
        evidence: {},
        ui: {
            buttons: ['12', '3', '4', '5', '6', '7', '8'],
            current: 0,
        }
    };

    // --- DOM Elements ---
    const apiKeyInput = document.getElementById('apiKey');
    const clearApiKeyBtn = document.getElementById('clearApiKeyBtn');
    const dciInput = document.getElementById('dci');
    const indicationInput = document.getElementById('indication');
    const genButtons = document.querySelectorAll('.gen-btn');
    const statusEl = document.getElementById('status');
    const reportFrame = document.getElementById('report-frame');
    const finalActionsContainer = document.getElementById('final-actions');
    const hiddenHtmlSource = document.getElementById('hidden-html-source');
    const copyBtn = document.getElementById('copyBtn');
    const downloadBtn = document.getElementById('downloadBtn');
    const loader = document.getElementById('loader');
    const API_KEY_STORAGE_KEY = 'CONAMEI_ASSISTANT_API_KEY';

    // --- TEMPLATE AND RENDERING ---
    const HTML_TEMPLATE = `
    <!DOCTYPE html><html lang="es"><head><meta charset="UTF-8"><title>Informe Técnico CONAMEI</title>
    <style>
        body { font-family: Calibri, Arial, sans-serif; font-size: 11pt; margin: 0; background-color: #eee; }
        .page { width: 210mm; min-height: 297mm; padding: 1.5cm; margin: 1cm auto; border: 1px #D3D3D3 solid; background: white; box-shadow: 0 0 5px rgba(0, 0, 0, 0.1); box-sizing: border-box; }
        table { width: 100%; border-collapse: collapse; margin-bottom: 10px; font-size: 9pt; }
        th, td { border: 1px solid black; padding: 4px 6px; text-align: left; vertical-align: top; word-break: break-word; }
        th { background-color: #E7E6E6; font-weight: bold; }
        .section-title { font-weight: bold; font-size: 10pt; background-color: #E7E6E6; padding: 6px; border: 1px solid black; margin-top: 15px; margin-bottom: -1px; }
        .sub-section-title { font-weight: bold; font-size: 9pt; margin-top: 10px; margin-bottom: 5px; }
        ul { padding-left: 20px; margin: 5px 0; } li { margin-bottom: 5px; font-size: 9pt; }
        p { margin: 5px 0; font-size: 9pt; text-align: justify; } .checkbox { font-size: 12pt; margin-right: 4px; }
    </style></head><body><div class="page">
        <p style="text-align: center; font-weight: bold;">INFORME TÉCNICO Nro. CONAMEI-2024-XX</p>
        <p class="section-title">1. IDENTIFICACIÓN DEL MEDICAMENTO</p>
        <table>
            <tr><th style="width:30%;">Código ATC</th><td>{{drug_id.atc_code}}</td></tr>
            <tr><th>DCI</th><td>{{drug_id.dci}}</td></tr>
            <tr><th>Forma farmacéutica (CNMB)</th><td>{{drug_id.pharma_form_cnmb}}</td></tr>
            <tr><th>Formas farmacéuticas (ARCSA)</th><td>{{drug_id.pharma_form_arcsa}}</td></tr>
            <tr><th>Concentración</th><td>{{drug_id.concentration}}</td></tr>
            <tr><th>Vía de administración</th><td>{{drug_id.admin_route}}</td></tr>
            <tr><th>Presentación comercial</th><td>{{drug_id.commercial_presentation}}</td></tr>
            <tr><th>Información sanitaria</th><td>{{drug_id.sanitary_info}}</td></tr>
        </table>
        <p class="section-title">2. INDICACIÓN TERAPÉUTICA</p>
        <table>
            <tr><th style="width:30%;">2.1. Indicación terapéutica</th><td>{{therapeutic_indication.indication_requested}}</td></tr>
            <tr><th>2.2. Mecanismo de acción</th><td><p>{{therapeutic_indication.mechanism_of_action}}</p></td></tr>
            <tr><th>2.3. Pauta de dosificación</th><td><p>{{therapeutic_indication.dosage_guideline}}</p></td></tr>
            <tr><th>2.4. Alternativas en CNMB</th><td><p>{{therapeutic_indication.alternatives_cnmb}}</p></td></tr>
            <tr><th>2.5. Alternativas no en CNMB</th><td><p>{{therapeutic_indication.alternatives_not_cnmb}}</p></td></tr>
        </table>
        <p class="section-title">3. POLÍTICAS DE COBERTURA</p>
        <p class="sub-section-title">3.1. Políticas de cobertura</p>
        <table><thead><tr><th>País/Agencia Sanitaria</th><th>Indicación y Condiciones de Cobertura</th><th>Fecha</th></tr></thead><tbody>{{coverage_policies_rows}}</tbody></table>
        <p class="sub-section-title">3.2. Indicaciones formalmente aprobadas</p>
        <table><thead><tr><th>Agencia sanitaria</th><th>Indicación aprobada</th><th>Tipo</th><th>Fecha</th></tr></thead><tbody>{{coverage_approvals_rows}}</tbody></table>
        <p class="section-title">4. BÚSQUEDA DE EVIDENCIA CIENTÍFICA</p>
        <p class="sub-section-title">4.1. Pregunta PICO</p>
        <table><tr><th style="width:10%;">P</th><td>{{pico.p}}</td></tr><tr><th>I</th><td>{{pico.i}}</td></tr><tr><th>C</th><td>{{pico.c}}</td></tr><tr><th>O</th><td>{{pico.o}}</td></tr></table>
        <p class="sub-section-title">4.2. Estrategia de Búsqueda</p>
        <table><thead><tr><th style="width:25%;">Base de Datos</th><th>Estrategia Utilizada</th></tr></thead><tbody>{{search_strategy_rows}}</tbody></table>
        <p class="sub-section-title">4.3. Selección de estudios</p>{{studies_tables}}
        <p class="section-title">5. DATOS DE EFICACIA Y SEGURIDAD</p>
        <p class="sub-section-title">5.1. Resumen de evidencia científica (Método GRADE)</p>{{grade_summary_tables}}
        <p class="sub-section-title">5.2. Datos de seguridad</p>
        <table><thead><tr><th>Frecuencia</th><th>Severidad</th><th>Detalle de reacciones adversas</th></tr></thead><tbody>{{safety_reactions_rows}}</tbody></table>
        <p><span class="checkbox">{{safety_has_alerts_checkbox}}</span> ¿Existen alertas sanitarias graves emitidas? <em>Detalle: {{efficacy_safety.safety_details.alerts_details}}</em></p>
        <p><span class="checkbox">{{safety_is_safer_checkbox}}</span> ¿Es más seguro que las alternativas del CNMB? <em>Justificación: {{efficacy_safety.safety_details.safety_justification}}</em></p>
        <p class="section-title">6. DATOS ECONÓMICOS</p>
        <p class="sub-section-title">6.1. Costo del tratamiento</p>
        <table><thead><tr><th>Parámetros</th><th>Intervención ({{drug_id.dci}})</th><th>Comparador ({{pico.c}})</th></tr></thead><tbody>
            <tr><th>Precio unitario (fuente)</th><td>{{economic_data.cost_treatment.intervention.unit_price}}</td><td>{{economic_data.cost_treatment.comparator.unit_price}}</td></tr>
            <tr><th>Posología</th><td>{{economic_data.cost_treatment.intervention.posology}}</td><td>{{economic_data.cost_treatment.comparator.posology}}</td></tr>
            <tr><th>Costo tratamiento/paciente/año</th><td>{{economic_data.cost_treatment.intervention.annual_cost_patient}}</td><td>{{economic_data.cost_treatment.comparator.annual_cost_patient}}</td></tr>
            <tr><th>Costo adicional/paciente/año</th><td>{{economic_data.cost_other.intervention.annual_cost_other}}</td><td>{{economic_data.cost_other.comparator.annual_cost_other}}</td></tr>
        </tbody></table>
        <p class="sub-section-title">6.2. Análisis de costos</p>
        <p><span class="checkbox">{{economic_is_cheaper_checkbox}}</span> ¿El costo del tratamiento es menor que el comparador? <em>Justificación: {{economic_data.cost_analysis_justification}}</em></p>
        <p class="sub-section-title">6.3. Estudios fármaco-económicos</p><p>{{economic_data.pharmacoeconomic_studies}}</p>
        <p class="section-title">7. DATOS DE CONVENIENCIA</p>
        <table><thead><tr><th>Parámetro</th><th>Respuesta</th><th>Justificativo</th></tr></thead><tbody>
            <tr><td>¿Frecuencia de administración menor?</td><td>{{convenience_frequency_checkbox}}</td><td>{{convenience_data.frequency.justification}}</td></tr>
            <tr><td>¿Mejora la adherencia?</td><td>{{convenience_adherence_checkbox}}</td><td>{{convenience_data.adherence.justification}}</td></tr>
            <tr><td>¿Disminuye hospitalización?</td><td>{{convenience_hospitalization_checkbox}}</td><td>{{convenience_data.hospitalization.justification}}</td></tr>
        </tbody></table>
        <p class="sub-section-title">7.2. Beneficios de forma farmacéutica/vía de administración</p><p>{{convenience_data.other_benefits}}</p>
        <p class="section-title">8. CONCLUSIÓN DEL REVISOR</p><p>{{conclusion_text}}</p>
        <p class="section-title">9. BIBLIOGRAFÍA</p><ul>{{bibliography_items}}</ul>
        <p class="section-title">10. FIRMA DE RESPONSABILIDAD</p><p style="margin-top: 50px;">_________________________<br>Elaborador</p>
    </div></body></html>`;

    const getValue = (obj, path, fallback = '') => _.get(obj, path, fallback);
    const renderCheckbox = (value) => `<span class="checkbox">${(value && String(value).toLowerCase() === 'si') ? '☑' : '☐'}</span>`;
    const renderSimpleRows = (data, columns) => { if (!Array.isArray(data)) return ''; return data.map(row => `<tr>${columns.map(col => `<td>${getValue(row, col)}</td>`).join('')}</tr>`).join(''); };
    const renderStudiesTables = (studies) => { if (!studies) return ''; let html = ''; const types = { meta_analysis: 'Meta-análisis', systematic_review: 'Revisión Sistemática', rct: 'Estudio Clínico Aleatorizado', observational: 'Estudio Observacional', gpc: 'Guía de Práctica Clínica' }; for (const key in types) { if (studies[key] && studies[key].length > 0) { studies[key].forEach(study => { html += `<p class="sub-section-title">${types[key]}</p><table><tr><th style="width:25%;">Referencia</th><td>${getValue(study, 'reference')}</td></tr><tr><th>Síntesis</th><td>${getValue(study, 'synthesis')}</td></tr></table>`; }); } } return html; };
    const renderGradeTables = (gradeSummary) => { if (!gradeSummary || !Array.isArray(gradeSummary.certainty_assessment)) return ''; let html = `<p><b>Pregunta:</b> ${getValue(gradeSummary, 'question')}</p><p><b>Bibliografía:</b> ${getValue(gradeSummary, 'bibliography')}</p>`; gradeSummary.certainty_assessment.forEach(ca => { html += `<p class="sub-section-title">Desenlace: ${getValue(ca, 'outcome')}</p><table style="font-size: 8pt;"><thead><tr><th>Diseño</th><th>Riesgo Sesgo</th><th>Inconsistencia</th><th>Evidencia Indirecta</th><th>Imprecisión</th><th>Otras</th><th>Certeza</th></tr></thead><tbody><tr><td>${getValue(ca, 'study_design')}</td><td>${getValue(ca, 'risk_of_bias')}</td><td>${getValue(ca, 'inconsistency')}</td><td>${getValue(ca, 'indirectness')}</td><td>${getValue(ca, 'imprecision')}</td><td>${getValue(ca, 'other_considerations')}</td><td><b>${getValue(ca, 'certainty')}</b></td></tr></tbody></table><table style="font-size: 8pt;"><thead><tr><th colspan="2">Efecto Absoluto</th><th>Efecto Relativo</th></tr></thead><tbody><tr><td><b>Intervención (${getValue(ca, 'intervention_effect_n')}p)</b></td><td><b>Control (${getValue(ca, 'control_effect_n')}p)</b></td><td rowspan="2">${getValue(ca, 'relative_effect')}</td></tr><tr><td>${getValue(ca, 'absolute_effect')}</td><td>--</td></tr></tbody></table>`; }); return html; };
    const renderSafetyReactions = (reactions) => { if (!Array.isArray(reactions)) return ''; return reactions.map(row => `<tr><td>${getValue(row, 'frequency')}</td><td>${getValue(row, 'severity')}</td><td>${getValue(row, 'details')}</td></tr>`).join(''); };
    const renderBibliography = (items) => { if (!Array.isArray(items)) return ''; return items.map(item => `<li>${item}</li>`).join(''); };

    function renderHtml(evidence) {
        let html = HTML_TEMPLATE;
        const replacements = {
            '{{drug_id.atc_code}}': getValue(evidence, 'drug_id.atc_code'), '{{drug_id.dci}}': getValue(evidence, 'drug_id.dci'), '{{drug_id.pharma_form_cnmb}}': getValue(evidence, 'drug_id.pharma_form_cnmb'), '{{drug_id.pharma_form_arcsa}}': getValue(evidence, 'drug_id.pharma_form_arcsa'), '{{drug_id.concentration}}': getValue(evidence, 'drug_id.concentration'), '{{drug_id.admin_route}}': getValue(evidence, 'drug_id.admin_route'), '{{drug_id.commercial_presentation}}': getValue(evidence, 'drug_id.commercial_presentation'), '{{drug_id.sanitary_info}}': getValue(evidence, 'drug_id.sanitary_info'),
            '{{therapeutic_indication.indication_requested}}': getValue(evidence, 'therapeutic_indication.indication_requested'), '{{therapeutic_indication.mechanism_of_action}}': getValue(evidence, 'therapeutic_indication.mechanism_of_action'), '{{therapeutic_indication.dosage_guideline}}': getValue(evidence, 'therapeutic_indication.dosage_guideline'), '{{therapeutic_indication.alternatives_cnmb}}': getValue(evidence, 'therapeutic_indication.alternatives_cnmb'), '{{therapeutic_indication.alternatives_not_cnmb}}': getValue(evidence, 'therapeutic_indication.alternatives_not_cnmb'),
            '{{pico.p}}': getValue(evidence, 'pico.p'), '{{pico.i}}': getValue(evidence, 'pico.i'), '{{pico.c}}': getValue(evidence, 'pico.c'), '{{pico.o}}': getValue(evidence, 'pico.o'),
            '{{economic_data.cost_treatment.intervention.unit_price}}': getValue(evidence, 'economic_data.cost_treatment.intervention.unit_price'), '{{economic_data.cost_treatment.comparator.unit_price}}': getValue(evidence, 'economic_data.cost_treatment.comparator.unit_price'), '{{economic_data.cost_treatment.intervention.posology}}': getValue(evidence, 'economic_data.cost_treatment.intervention.posology'), '{{economic_data.cost_treatment.comparator.posology}}': getValue(evidence, 'economic_data.cost_treatment.comparator.posology'), '{{economic_data.cost_treatment.intervention.annual_cost_patient}}': getValue(evidence, 'economic_data.cost_treatment.intervention.annual_cost_patient'), '{{economic_data.cost_treatment.comparator.annual_cost_patient}}': getValue(evidence, 'economic_data.cost_treatment.comparator.annual_cost_patient'), '{{economic_data.cost_other.intervention.annual_cost_other}}': getValue(evidence, 'economic_data.cost_other.intervention.annual_cost_other'), '{{economic_data.cost_other.comparator.annual_cost_other}}': getValue(evidence, 'economic_data.cost_other.comparator.annual_cost_other'), '{{economic_data.cost_analysis_justification}}': getValue(evidence, 'economic_data.cost_analysis_justification'), '{{economic_data.pharmacoeconomic_studies}}': getValue(evidence, 'economic_data.pharmacoeconomic_studies'),
            '{{convenience_data.frequency.justification}}': getValue(evidence, 'convenience_data.frequency.justification'), '{{convenience_data.adherence.justification}}': getValue(evidence, 'convenience_data.adherence.justification'), '{{convenience_data.hospitalization.justification}}': getValue(evidence, 'convenience_data.hospitalization.justification'), '{{convenience_data.other_benefits}}': getValue(evidence, 'convenience_data.other_benefits'),
            '{{efficacy_safety.safety_details.alerts_details}}': getValue(evidence, 'efficacy_safety.safety_details.alerts_details'), '{{efficacy_safety.safety_details.safety_justification}}': getValue(evidence, 'efficacy_safety.safety_details.safety_justification'),
            '{{conclusion_text}}': getValue(evidence, 'conclusion_text', 'Conclusión pendiente...'),
        };
        for(const placeholder in replacements) { html = html.replace(new RegExp(placeholder.replace(/[-\/\\^$*+?.()|[\]{}]/g, '\\$&'), 'g'), replacements[placeholder]); }
        html = html.replace('{{coverage_policies_rows}}', renderSimpleRows(getValue(evidence, 'coverage.policies', []), ['agency', 'indication', 'date']));
        html = html.replace('{{coverage_approvals_rows}}', renderSimpleRows(getValue(evidence, 'coverage.approvals', []), ['agency', 'indication', 'type', 'date']));
        html = html.replace('{{search_strategy_rows}}', renderSimpleRows(getValue(evidence, 'search_strategy', []), ['database', 'strategy']));
        html = html.replace('{{studies_tables}}', renderStudiesTables(getValue(evidence, 'studies')));
        html = html.replace('{{grade_summary_tables}}', renderGradeTables(getValue(evidence, 'efficacy_safety.grade_summary')));
        html = html.replace('{{safety_reactions_rows}}', renderSafetyReactions(getValue(evidence, 'efficacy_safety.safety_details.adverse_reactions', [])));
        html = html.replace('{{bibliography_items}}', renderBibliography(getValue(evidence, 'bibliography', [])));
        html = html.replace('{{safety_has_alerts_checkbox}}', renderCheckbox(getValue(evidence, 'efficacy_safety.safety_details.has_alerts')));
        html = html.replace('{{safety_is_safer_checkbox}}', renderCheckbox(getValue(evidence, 'efficacy_safety.safety_details.is_safer_than_cnmb')));
        html = html.replace('{{economic_is_cheaper_checkbox}}', renderCheckbox(getValue(evidence, 'economic_data.is_cheaper')));
        html = html.replace('{{convenience_frequency_checkbox}}', renderCheckbox(getValue(evidence, 'convenience_data.frequency.answer')));
        html = html.replace('{{convenience_adherence_checkbox}}', renderCheckbox(getValue(evidence, 'convenience_data.adherence.answer')));
        html = html.replace('{{convenience_hospitalization_checkbox}}', renderCheckbox(getValue(evidence, 'convenience_data.hospitalization.answer')));
        return html;
    }

    // --- Core Application Logic ---
    async function handleGenerateSection(e) {
        const section = e.target.dataset.section;
        appState.dci = dciInput.value.trim();
        appState.indication = indicationInput.value.trim();
        if (!appState.apiKey || !appState.dci || !appState.indication) {
            showStatus("ERROR: Completa API Key, DCI e Indicación.");
            return;
        }
        showStatus(`Generando sección ${section}...`, true);
        try {
            const prompt = getPromptForSection(section);
            const API_URL = `https://generativelanguage.googleapis.com/v1beta/models/gemini-1.5-pro-latest:generateContent?key=${appState.apiKey}`;
            const response = await fetch(API_URL, {
                method: 'POST', headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ contents: [{ parts: [{ text: prompt }] }] })
            });
            if (!response.ok) throw new Error(`Error en API: ${response.status}`);
            const data = await response.json();
            const jsonText = data.candidates[0].content.parts[0].text.replace(/^```json\s*|```\s*$/g, '').trim();
            const result = JSON.parse(jsonText);
            _.merge(appState.evidence, result);
            appState.ui.current++;
            updateButtonState();
            renderPreview();
            showStatus(appState.ui.current < appState.ui.buttons.length ? `Sección ${section} generada. Listo para el siguiente paso.` : 'Todas las secciones generadas.');
        } catch (error) {
            console.error(`Error en sección ${section}:`, error);
            showStatus(`Error al generar sección ${section}: ${error.message}. Intenta de nuevo.`);
        } finally {
            showStatus(statusEl.textContent, false);
            updateButtonState();
        }
    }

    function renderPreview() {
        const fullHtml = renderHtml(appState.evidence);
        reportFrame.srcdoc = fullHtml;
        hiddenHtmlSource.value = fullHtml;
    }

    function getPromptForSection(section) {
        const { dci, indication, evidence } = appState;
        const basePrompt = `Actúa como un farmacólogo y analista experto en HTA para CONASA, Ecuador. Investiga y rellena la siguiente estructura JSON para "${dci}" en la indicación "${indication}". Tu única salida debe ser el objeto JSON puro.`;
        const rules = `REGLAS CRÍTICAS: Para 'pico.c' y todas las comparaciones, usa la alternativa terapéutica más relevante del Cuadro Nacional de Medicamentos Básico (CNMB) de Ecuador. Si no existe, indícalo. Rellena cada campo; si no encuentras un dato, usa "No encontrado".`;
        const prompts = {
            '12': { ctx: "", json: `{"drug_id": {"atc_code":"","dci":"${dci}","pharma_form_cnmb":"","pharma_form_arcsa":"","concentration":"","admin_route":"","commercial_presentation":"","sanitary_info":""},"therapeutic_indication":{"indication_requested":"${indication}","mechanism_of_action":"","dosage_guideline":"","alternatives_cnmb":"","alternatives_not_cnmb":""}}` },
            '3': { ctx: "", json: `{"coverage":{"policies":[],"approvals":[]}}` },
            '4': { ctx: `El comparador principal del CNMB es: ${getValue(evidence, 'therapeutic_indication.alternatives_cnmb', 'No definido aún')}.`, json: `{"pico":{"p":"Población para: ${indication}","i":"${dci}","c":"","o":""},"search_strategy":[]}` },
            '5': { ctx: `El comparador es: ${getValue(evidence, 'pico.c', 'No definido')}.`, json: `{"studies":{"meta_analysis":[],"systematic_review":[],"rct":[],"observational":[],"gpc":[]},"efficacy_safety":{"grade_summary":{"question":"¿Debería usarse ${dci} vs ${getValue(evidence, 'pico.c', 'el comparador')} para ${indication}?","bibliography":"","certainty_assessment":[]},"safety_details":{"adverse_reactions":[],"has_alerts":"No","alerts_details":"","is_safer_than_cnmb":"No","safety_justification":""}}}` },
            '6': { ctx: "", json: `{"economic_data":{"cost_treatment":{"intervention":{"unit_price":"","posology":"","annual_cost_patient":""},"comparator":{"unit_price":"","posology":"","annual_cost_patient":""}},"cost_other":{"intervention":{"annual_cost_other":""},"comparator":{"annual_cost_other":""}},"is_cheaper":"No","cost_analysis_justification":"","pharmacoeconomic_studies":""}}` },
            '7': { ctx: "", json: `{"convenience_data":{"frequency":{"answer":"No","justification":""},"adherence":{"answer":"No","justification":""},"hospitalization":{"answer":"No","justification":""},"other_benefits":""},"bibliography":[]}` },
            '8': { ctx: `Has recibido el siguiente JSON con la evidencia sobre "${dci}". Tu única tarea es redactar un párrafo para la "CONCLUSIÓN DEL REVISOR". Debe ser conciso y balanceado. Tu única salida debe ser un JSON con la clave "conclusion_text".\n\nEvidencia: ${JSON.stringify(evidence)}`, json: `{"conclusion_text":""}` }
        };
        const sectionData = prompts[section];
        return `${basePrompt}\n${rules}\n${sectionData.ctx}\n\nGenera un JSON con la siguiente estructura y contenido:\n${sectionData.json}`;
    }

    // --- Event Listeners ---
    function setupListeners() {
        genButtons.forEach(btn => btn.addEventListener('click', handleGenerateSection));
        copyBtn.addEventListener('click', () => navigator.clipboard.writeText(hiddenHtmlSource.value));
        downloadBtn.addEventListener('click', () => {
            const blob = new Blob([hiddenHtmlSource.value], { type: 'text/html' });
            const a = document.createElement('a');
            a.href = URL.createObjectURL(blob);
            a.download = `informe_conamei_${appState.dci.toLowerCase() || 'informe'}.html`;
            a.click();
        });
    }

    function init() {
        const savedApiKey = localStorage.getItem(API_KEY_STORAGE_KEY);
        if (savedApiKey) {
            apiKeyInput.value = savedApiKey;
            appState.apiKey = savedApiKey;
        }
        apiKeyInput.addEventListener('input', () => {
            appState.apiKey = apiKeyInput.value;
            localStorage.setItem(API_KEY_STORAGE_KEY, appState.apiKey);
        });
        clearApiKeyBtn.addEventListener('click', () => {
            apiKeyInput.value = '';
            appState.apiKey = '';
            localStorage.removeItem(API_KEY_STORAGE_KEY);
        });
        setupListeners();
        updateButtonState();
        renderPreview();
    }

    init();
});
</script>
</body>
</html>
