<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Asistente de Generación de Informes CONAMEI (v3)</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <style>
        body { font-family: 'Inter', sans-serif; }
        .loader {
            border: 4px solid #f3f3f3;
            border-top: 4px solid #3b82f6;
            border-radius: 50%;
            width: 30px;
            height: 30px;
            animation: spin 1s linear infinite;
        }
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        .status-message {
            transition: opacity 0.5s ease-in-out;
        }
    </style>
</head>
<body class="bg-gray-100 p-4 sm:p-6 md:p-8">
    <div class="max-w-4xl mx-auto bg-white rounded-xl shadow-lg overflow-hidden">
        <div class="bg-gray-800 p-6">
            <h1 class="text-2xl font-bold text-white">Asistente de Generación de Informes CONAMEI</h1>
            <p class="text-gray-300 mt-1">Automatiza la búsqueda de evidencia y la creación de prompts para Google AI.</p>
        </div>

        <div class="p-6 md:p-8 space-y-6">
            <!-- PASO 0: API KEY -->
            <div>
                <label for="apiKey" class="block text-sm font-medium text-gray-700">Tu API Key de Google AI</label>
                <div class="mt-1 flex items-center space-x-2">
                    <input type="password" id="apiKey" class="block w-full rounded-md border-gray-300 shadow-sm focus:border-indigo-500 focus:ring-indigo-500 sm:text-sm" placeholder="Pega tu clave aquí (se guardará localmente)">
                    <button id="clearApiKeyBtn" class="rounded-md border border-gray-300 bg-white px-3 py-2 text-xs font-medium text-gray-700 shadow-sm hover:bg-gray-50">Borrar</button>
                </div>
                <p class="mt-1 text-xs text-gray-500">Tu clave se guarda de forma segura en tu navegador.</p>
            </div>

            <!-- PASO 1: INPUTS -->
            <div class="grid grid-cols-1 md:grid-cols-2 gap-6 border-t pt-6">
                <div>
                    <label for="dci" class="block text-sm font-medium text-gray-700">Nombre del Medicamento (DCI)</label>
                    <input type="text" id="dci" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-indigo-500 focus:ring-indigo-500 sm:text-sm" placeholder="Ej: Ofatumumab">
                </div>
                <div>
                    <label for="indication" class="block text-sm font-medium text-gray-700">Indicación Principal Solicitada</label>
                    <input type="text" id="indication" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-indigo-500 focus:ring-indigo-500 sm:text-sm" placeholder="Ej: Esclerosis Múltiple Recurrente">
                </div>
            </div>

            <!-- BOTÓN DE ACCIÓN Y ESTADO -->
            <div class="flex items-center space-x-4">
                <button id="generateBtn" class="inline-flex items-center rounded-md border border-transparent bg-blue-600 px-4 py-2 text-sm font-medium text-white shadow-sm hover:bg-blue-700 focus:outline-none focus:ring-2 focus:ring-blue-500 focus:ring-offset-2">
                    1. Buscar Evidencia y Generar Prompt
                </button>
                <div id="loader" class="loader hidden"></div>
                <p id="status" class="text-sm text-gray-600 status-message"></p>
            </div>

            <!-- PASO 2: RESULTADO -->
            <div id="result-container" class="hidden border-t pt-6">
                <label for="result" class="block text-sm font-bold text-green-700">Prompt JSON Generado (Listo para AI Studio)</label>
                <textarea id="result" rows="20" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm font-mono text-xs focus:border-indigo-500 focus:ring-indigo-500"></textarea>
                <div class="mt-4 flex flex-wrap gap-3">
                    <button id="copyBtn" class="inline-flex items-center rounded-md border border-transparent bg-green-600 px-4 py-2 text-sm font-medium text-white shadow-sm hover:bg-green-700">
                        2. Copiar Prompt
                    </button>
                    <button id="downloadBtn" class="inline-flex items-center rounded-md border border-gray-300 bg-white px-4 py-2 text-sm font-medium text-gray-700 shadow-sm hover:bg-gray-50">
                        Descargar como .json
                    </button>
                </div>
                 <p class="mt-2 text-xs text-gray-500">Ahora, ve a Google AI Studio, pega este prompt y ejecuta para obtener el informe HTML final.</p>
            </div>
        </div>
    </div>

    <script>
        const generateBtn = document.getElementById('generateBtn');
        const apiKeyInput = document.getElementById('apiKey');
        const clearApiKeyBtn = document.getElementById('clearApiKeyBtn');
        const dciInput = document.getElementById('dci');
        const indicationInput = document.getElementById('indication');
        const loader = document.getElementById('loader');
        const statusEl = document.getElementById('status');
        const resultContainer = document.getElementById('result-container');
        const resultTextarea = document.getElementById('result');
        const copyBtn = document.getElementById('copyBtn');
        const downloadBtn = document.getElementById('downloadBtn');

        const API_KEY_STORAGE_KEY = 'CONAMEI_ASSISTANT_API_KEY_V3';
        let lastStatusMessage = ''; 

        // --- PLANTILLA MAESTRA DEL PROMPT FINAL (ESTRUCTURA ROBUSTA V3) ---
        const finalPromptTemplate = {
          "prompt_instructions": {
            "role": "Actúa como un motor de evaluación de HTA y desarrollador web experto, con la tarea de replicar y automatizar el informe oficial del comité técnico de CONAMEI para la inclusión de medicamentos en el Cuadro Nacional de Medicamentos Básicos (CNMB) de Ecuador.",
            "task": "Tu tarea es generar un único archivo HTML completo y válido que sea una réplica visual y estructuralmente idéntica del formulario CONAMEI. Utiliza la información en `report_content` para rellenar las secciones informativas. Para la Matriz de Evaluación final, debes aplicar la lógica computacional definida en `automated_evaluation_logic` para calcular el 'PUNTAJE TOTAL' y la 'DECISIÓN' final ('PASA A SEGUNDA ETAPA' o 'NO PASA ETAPA'), justificando cada calificación con la evidencia recopilada.",
            "styling_requirements": { "framework": "No uses un framework. Replica el estilo del ejemplo usando un único bloque `<style>` en el `<head>`. Utiliza fuentes como Calibri y Arial, un diseño de página A4 fijo, y tablas con bordes negros (`1px solid black`)." },
            "automated_evaluation_logic": {
              "overall_goal": "Tu tarea más crítica es completar de forma autónoma la 'MATRIZ 1: EVALUACIÓN INICIAL' y generar la 'CONCLUSIÓN DEL REVISOR'. No debes copiar los puntajes; debes calcularlos y justificarlos basándote en la evidencia presentada.",
              "step_by_step_process": [
                "1. Para cada criterio en el array `parameters` de la Matriz, analiza la evidencia presentada en el resto del informe para determinar el 'RESULTADO' correcto.",
                "2. Una vez determinado el 'RESULTADO', busca en el objeto `scoring_rules` la calificación numérica (`score`) correspondiente y asígnala.",
                "3. **Genera una justificación concisa y específica para CADA calificación**, explicando por qué se asignó ese puntaje en base a la evidencia del informe. Ej: 'Eficacia comparable a Ocrelizumab según NMA de Samjoo et al. (0)'.",
                "4. Después de calificar y justificar todos los criterios, suma todas las calificaciones para obtener el 'PUNTAJE TOTAL'.",
                "5. Aplica la `decision_rule` al 'PUNTAJE TOTAL' para determinar la 'DECISIÓN' final.",
                "6. **Genera el texto para la 'CONCLUSIÓN DEL REVISOR' (sección 8)** usando las plantillas de `argumentative_conclusion_logic`. Elige la plantilla 'pass' o 'fail' según la decisión. Sintetiza los argumentos más fuertes de tu evaluación para rellenar los placeholders.",
                "7. Renderiza el informe completo, incluyendo la matriz y la conclusión que has generado."
              ],
              "scoring_rules": {
                "¿Cuál es la calidad de la evidencia científica?": { "Alta": 2, "Moderada": 1, "Baja o muy baja": 0 },
                "¿Cuál es la fase de investigación clínica?": { "Fase IV+": 2, "Fase III+": 1, "Fase IV-": 0, "Fase III-": -1 },
                "¿Es un medicamento considerado como esencial por la OMS?": { "Si": 1, "No": 0 },
                "¿Mejora el desenlace final de la enfermedad?": { "Si": 1, "No y/o se desconoce": 0 },
                "¿La eficacia es superior, igual o inferior al comparador?": { "Superior": 1, "No Inferior": 0, "Inferior": -1 },
                "¿Mejora la calidad de vida del paciente?": { "Si": 1, "No y/o se desconoce": 0 },
                "¿Puede provocar reacciones adversas letales o graves?": { "Poco frecuente": 0, "Frecuente": -1, "Muy frecuente": -2 },
                "¿Es más seguro que las alternativas del CNMB?": { "Si": 1, "No y/o se desconoce": 0 },
                "¿Existen alertas sanitarias graves emitidas?": { "Si": -1, "No": 1 },
                "¿La indicación tiene una prevalencia >5%?": { "Si": 1, "No": 0 },
                "¿Existe una alternativa terapéutica dentro del CNMB?": { "No": 1, "Si": 0 },
                "¿Mejora la adherencia y/o reduce la estancia hospitalaria?": { "Si": 1, "No": 0 },
                "¿El costo del tratamiento frente al comparador es menor, igual o mayor?": { "Menor": 1, "Igual": 0, "Mayor": -1 }
              },
              "decision_rule": { "threshold": 7, "pass_text": "PASA A SEGUNDA ETAPA", "fail_text": "NO PASA ETAPA" },
              "argumentative_conclusion_logic": {
                "pass_template": "Tanto [DCI] como [Comparador] han demostrado una alta eficacia en la reducción de la tasa anual de recaídas (ARR) y la progresión de la discapacidad. Los metaanálisis en red sugieren un rendimiento comparable. En seguridad, [DCI] presenta un perfil más favorable, con [ventaja de seguridad clave]. Económicamente, [DCI] es [dominante/costo-efectivo], siendo [más/menos] costoso que [Comparador] según precios locales y análisis farmacoeconómicos. La conveniencia de la autoadministración es una ventaja significativa. Por todo lo expuesto, se considera que [DCI] representa una alternativa de alto valor para el sistema de salud.",
                "fail_template": "Aunque [DCI] demuestra una eficacia comparable a [Comparador], existen preocupaciones significativas. El perfil de seguridad, aunque manejable, incluye [riesgo de seguridad clave]. Económicamente, el [alto costo/falta de dominio] representa una barrera importante para la sostenibilidad del sistema de salud, a pesar de los beneficios de conveniencia. Dada la falta de una ventaja clara en eficacia y las consideraciones de costo y seguridad, la propuesta de valor no justifica la inclusión en este momento."
              }
            },
            "final_output": "El resultado debe ser un único bloque de código HTML que comience con `<!DOCTYPE html>` y termine con `</html>`, sin ningún texto o explicación adicional fuera del código.",
            "report_content": {
              "report_metadata": { "report_id": "CONAMEI-2025-0X", "city_date": "Quito, D.M., [Fecha Actual]" },
              "sections": [
                { "section_number": "1", "title": "IDENTIFICACIÓN DEL MEDICAMENTO", "data": [
                    {"key": "1.1. Código ATC", "value": "[ATC_CODE]"}, {"key": "1.2. DCI", "value": "[DCI]"}, {"key": "1.3. Forma farmacéutica (CNMB)", "value": "[PHARMA_FORM_CNMB]"}, {"key": "1.4. Formas farmacéuticas (ARCSA)", "value": "[PHARMA_FORM_ARCSA]"}, {"key": "1.5. Concentración", "value": "[CONCENTRATION]"}, {"key": "1.6. Vía de administración", "value": "[ADMIN_ROUTE]"}, {"key": "1.7. Presentación comercial", "value": "[COMMERCIAL_PRESENTATION]"}, {"key": "1.8. Información sanitaria", "value": "[SANITARY_INFO]"}
                ]},
                { "section_number": "2", "title": "INDICACIÓN TERAPÉUTICA", "data": [
                    {"key": "2.1. Indicación terapéutica para la cual se solicita", "value": "[INDICATION]"}, {"key": "2.2. Mecanismo de acción", "value": "[MECHANISM_OF_ACTION]"}, {"key": "2.3. Pauta de dosificación", "value": "[DOSAGE_GUIDELINE]"}, {"key": "2.4. Alternativas terapéuticas disponibles en el CNMB vigente", "value": "[ALTERNATIVES_CNMB]"}, {"key": "2.5. Alternativas terapéuticas no presentes en el CNMB vigente", "value": "[ALTERNATIVES_NOT_CNMB]"}
                ]},
                { "section_number": "3", "title": "POLÍTICAS DE COBERTURA", "policies": { "title": "Políticas de cobertura", "headers": ["País/Agencia Sanitaria", "Indicación cubierta", "Fecha inicio cobertura"], "rows": "[COVERAGE_POLICIES_ROWS]" }, "approvals": { "title": "Indicaciones formalmente aprobadas", "headers": ["Agencia sanitaria", "Indicación aprobada", "Tipo aprobación"], "rows": "[APPROVALS_ROWS]" }},
                { "section_number": "4", "title": "BÚSQUEDA DE EVIDENCIA CIENTÍFICA", "pico": { "P": "Pacientes adultos con [INDICATION]", "I": "[DCI]", "C": "[COMPARATOR]", "O": "Eficacia, seguridad y costo." }},
                { "section_number": "5", "title": "DATOS DE EFICACIA Y SEGURIDAD", "evidence_summary": [
                    {"key": "Referencia Clave (Eficacia)", "value": "[EFFICACY_NMA_REF]"}, {"key": "Diseño", "value": "Revisión sistemática y metaanálisis en red (NMA)."}, {"key": "Hallazgos de Eficacia", "value": "[EFFICACY_NMA_FINDINGS]"}
                  ], "grade_tables": "[GRADE_TABLES_HTML]",
                  "safety_summary_table": {
                      "title": "Datos de Seguridad del Medicamento",
                      "data": [
                          {"key": "Referencia Clave", "value": "[SAFETY_NMA_REF]"},
                          {"key": "Frecuencia y Severidad de RAM", "value": "[SAFETY_FREQUENCY_SEVERITY]"},
                          {"key": "Detalle de Reacciones Adversas", "value": "[SAFETY_DETAILS]"},
                          {"key": "Alertas de Agencias de Alta Vigilancia", "value": "[SAFETY_ALERTS]"},
                          {"key": "¿Más seguro que la alternativa del CNMB?", "value": "[IS_SAFER_JUSTIFICATION]"}
                      ]
                  }
                },
                { "section_number": "6", "title": "DATOS ECONÓMICOS", "cost_table": { "headers": ["Parámetros", "[DCI]", "[COMPARATOR]"], "rows": "[COST_TABLE_ROWS]" }, "cost_analysis": { "key": "¿El costo del tratamiento es menor que el comparador?", "value": "[COST_ANALYSIS_JUSTIFICATION]" }, "pharmacoeconomic_summary": { "key": "Estudios fármaco-económicos", "value": "[PHARMACOECONOMIC_SUMMARY]" }},
                { "section_number": "7", "title": "DATOS DE CONVENIENCIA", "convenience_table": { "headers": ["Parámetro", "Respuesta", "Justificativo"], "rows": "[CONVENIENCE_ROWS]" }},
                { "section_number": "8", "title": "CONCLUSIÓN DEL REVISOR", "text": "[REVIEWER_CONCLUSION]"},
                { "section_number": "9", "title": "FIRMA DE RESPONSABILIDAD", "signature": { "elaborator": "Equipo Técnico Evaluador", "institution": "CONAMEI", "date": "[Fecha Actual]" }},
                { "section_number": "10", "title": "REFERENCIAS", "items": "[REFERENCES_LIST]" },
                { "section_number": "MATRIZ", "title": "MATRIZ 1: EVALUACIÓN INICIAL (Resumen)", "drug_info": { "dci": "[DCI]", "comparator": "[COMPARATOR]" }, "parameters": [
                    {"category": "EFICACIA", "question": "¿Cuál es la calidad de la evidencia científica?", "result": "[EVIDENCE_QUALITY]", "score": null, "justification": "Basada en ECAs pivotales y metaanálisis en red de alta calidad."},
                    {"category": "EFICACIA", "question": "¿Cuál es la fase de investigación clínica?", "result": "[RESEARCH_PHASE]", "score": null, "justification": "Aprobado y en uso post-comercialización por agencias de alta vigilancia."},
                    {"category": "EFICACIA", "question": "¿Es un medicamento considerado como esencial por la OMS?", "result": "[WHO_ESSENTIAL]", "score": null, "justification": "No se encuentra en la Lista Modelo de Medicamentos Esenciales de la OMS."},
                    {"category": "EFICACIA", "question": "¿Mejora el desenlace final de la enfermedad?", "result": "[IMPROVES_OUTCOME]", "score": null, "justification": "Reduce significativamente la tasa de brotes y la progresión de la discapacidad."},
                    {"category": "EFICACIA", "question": "¿La eficacia es superior, igual o inferior al comparador?", "result": "[EFFICACY_COMPARISON]", "score": null, "justification": "Eficacia comparable a [COMPARATOR] según metaanálisis en red."},
                    {"category": "EFICACIA", "question": "¿Mejora la calidad de vida del paciente?", "result": "[IMPROVES_QOL]", "score": null, "justification": "La autoadministración y reducción de brotes mejoran la calidad de vida."},
                    {"category": "SEGURIDAD", "question": "¿Puede provocar reacciones adversas letales o graves?", "result": "[LETHAL_ADVERSE_REACTIONS]", "score": null, "justification": "Las infecciones del tracto respiratorio son frecuentes y pueden ser graves."},
                    {"category": "SEGURIDAD", "question": "¿Es más seguro que las alternativas del CNMB?", "result": "[IS_SAFER]", "score": null, "justification": "Perfil de seguridad más favorable que [COMPARATOR] (menos reacciones infusionales, menos infecciones)."},
                    {"category": "SEGURIDAD", "question": "¿Existen alertas sanitarias graves emitidas?", "result": "[HAS_SAFETY_ALERTS]", "score": null, "justification": "Sí, alertas de clase sobre riesgo de infecciones (VHB, LMP) para los anti-CD20."},
                    {"category": "PREVALENCIA / FRECUENCIA", "question": "¿La indicación tiene una prevalencia >5%?", "result": "[PREVALENCE_OVER_5]", "score": null, "justification": "La prevalencia de la Esclerosis Múltiple en Ecuador es menor al 5%."},
                    {"category": "CONVENIENCIA", "question": "¿Existe una alternativa terapéutica dentro del CNMB?", "result": "[IS_CNMB_ALTERNATIVE]", "score": null, "justification": "Sí, existen otras terapias de alta eficacia como Fingolimod en el CNMB."},
                    {"category": "CONVENIENCIA", "question": "¿Mejora la adherencia y/o reduce la estancia hospitalaria?", "result": "[IMPROVES_ADHERENCE]", "score": null, "justification": "La administración SC en casa mejora adherencia y elimina visitas para infusión IV."},
                    {"category": "COSTO", "question": "¿El costo del tratamiento frente al comparador es menor, igual o mayor?", "result": "[COST_COMPARISON]", "score": null, "justification": "Costo anual significativamente [menor/mayor] que [COMPARATOR] según precios SERCOP."}
                  ]
                }
              ]
            }
          }
        };

        function showStatus(message, isTemporary = false, duration = 3000) {
            statusEl.textContent = message;
            if (!isTemporary) {
                lastStatusMessage = message;
            } else {
                setTimeout(() => {
                    if (statusEl.textContent === message) {
                        statusEl.textContent = lastStatusMessage;
                    }
                }, duration);
            }
        }

        document.addEventListener('DOMContentLoaded', () => {
            const savedApiKey = localStorage.getItem(API_KEY_STORAGE_KEY);
            if (savedApiKey) {
                apiKeyInput.value = savedApiKey;
                showStatus('API Key cargada desde el almacenamiento local.', true);
            }
        });

        apiKeyInput.addEventListener('input', () => {
            localStorage.setItem(API_KEY_STORAGE_KEY, apiKeyInput.value);
        });
        
        clearApiKeyBtn.addEventListener('click', () => {
            localStorage.removeItem(API_KEY_STORAGE_KEY);
            apiKeyInput.value = '';
            showStatus('Clave de API borrada del almacenamiento local.', true);
        });

        async function handleGenerateClick() {
            const apiKey = apiKeyInput.value.trim();
            const dci = dciInput.value.trim();
            const indication = indicationInput.value.trim();

            if (!apiKey || !dci || !indication) {
                showStatus("Por favor, completa todos los campos: API Key, Medicamento e Indicación.");
                return;
            }

            generateBtn.disabled = true;
            loader.classList.remove('hidden');
            resultContainer.classList.add('hidden');
            showStatus('Buscando evidencia... (Esto puede tardar hasta un minuto)');

            try {
                const searcherPrompt = `
                    Actúa como un investigador médico experto y analista de HTA. Para el medicamento "${dci}" con la indicación principal de "${indication}", busca la siguiente información y responde en un único objeto JSON.
                    
                    {
                        "section1_data": {"atc_code": "...", "pharma_form_cnmb": "...", "pharma_form_arcsa": "...", "concentration": "...", "admin_route": "...", "commercial_presentation": "...", "sanitary_info": "..."},
                        "section2_data": {"mechanism_of_action": "...", "dosage_guideline": "...", "alternatives_cnmb": "...", "alternatives_not_cnmb": "..."},
                        "section3_data": {"policies": [{"country_agency": "...", "indication": "...", "date": "..."}], "approvals": [{"agency": "...", "indication": "...", "type": "..."}]},
                        "section4_data": {"comparator": "Identifica el comparador de alta eficacia más relevante (ej. Ocrelizumab)"},
                        "section5_data": {
                            "efficacy_nma_ref": "Cita el NMA de eficacia más importante (ej. Samjoo et al.)",
                            "efficacy_nma_findings": "Resume los hallazgos clave de eficacia comparando ${dci} con su comparador de alta eficacia.",
                            "grade_tables_html": "Genera dos tablas HTML simples con los datos de eficacia del NMA para los desenlaces 'Tasa de Recaída Anualizada' y 'Progresión de Discapacidad a 3 meses'.",
                            "safety_nma_ref": "Cita el NMA de seguridad más importante (ej. Śladowska et al.)",
                            "safety_frequency_severity": "Resume la frecuencia y severidad de las RAMs más comunes.",
                            "safety_details": "Detalla las reacciones adversas más importantes.",
                            "safety_alerts": "Describe cualquier alerta sanitaria grave de agencias como FDA/EMA o la OMS.",
                            "is_safer_justification": "Justifica si es más seguro que el comparador, basándose en el NMA de seguridad."
                        },
                        "section6_data": {
                            "cost_table_rows": [{"parameter": "Costo del tratamiento por paciente al año", "intervention_value": "Busca el costo anual de ${dci} en USD (prioriza datos de SERCOP Ecuador si están disponibles)", "comparator_value": "Busca el costo anual del comparador en USD (prioriza SERCOP)"}],
                            "cost_analysis_justification": "Compara los costos y justifica si es menor, igual o mayor.",
                            "pharmacoeconomic_summary": "Resume si agencias como NICE lo consideran costo-efectivo o si existen estudios de dominancia."
                        },
                        "section7_data": {
                            "convenience_rows": [
                                {"parameter": "¿Frecuencia de administración menor?", "response": "Si/No", "justification": "..."},
                                {"parameter": "¿Mejora adherencia?", "response": "Si/No", "justification": "..."},
                                {"parameter": "¿Disminuye hospitalización?", "response": "Si/No", "justification": "..."}
                            ]
                        },
                        "section10_data": {"references": ["Cita las referencias de los NMAs y estudios farmacoeconómicos encontrados."]},
                        "matriz_data": {
                            "evidence_quality": "Alta/Moderada/Baja", "research_phase": "Fase IV+/Fase III+", "who_essential": "Si/No", "improves_outcome": "Si/No", "efficacy_comparison": "Superior/No Inferior/Inferior", "improves_qol": "Si/No",
                            "lethal_adverse_reactions": "Poco frecuente/Frecuente/Muy frecuente", "is_safer": "Si/No", "has_safety_alerts": "Si/No", "prevalence_over_5": "Si/No", "is_cnmb_alternative": "Si/No",
                            "improves_adherence": "Si/No", "cost_comparison": "Menor/Igual/Mayor"
                        }
                    }
                `;

                const API_URL = `https://generativelanguage.googleapis.com/v1beta/models/gemini-1.5-flash-latest:generateContent?key=${apiKey}`;
                
                const response = await fetch(API_URL, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ contents: [{ parts: [{ text: searcherPrompt }] }] })
                });

                if (!response.ok) {
                    const errorData = await response.json();
                    throw new Error(`Error en la API: ${response.status} - ${errorData.error?.message || 'Respuesta de error desconocida'}`);
                }

                const data = await response.json();
                let evidenceText = data.candidates[0].content.parts[0].text;
                evidenceText = evidenceText.replace(/^```json\s*|```\s*$/g, '').trim();
                const evidence = JSON.parse(evidenceText);

                showStatus('Evidencia encontrada. Poblando plantilla completa...');
                const finalPrompt = buildFinalPrompt(dci, indication, evidence);

                resultTextarea.value = JSON.stringify(finalPrompt, null, 2);
                resultContainer.classList.remove('hidden');
                showStatus('¡Listo! El prompt JSON completo está preparado.');

            } catch (error) {
                console.error(error);
                let errorMessage = `Error: ${error.message}. Revisa la consola (F12) para más detalles.`;
                if (error.message.includes('API key not valid')) {
                    errorMessage = 'Error: La API Key no es válida. Por favor, verifica que sea correcta.';
                } else if (error instanceof SyntaxError) {
                    errorMessage = 'Error: La respuesta de la API no es un JSON válido. Inténtalo de nuevo.';
                }
                showStatus(errorMessage);
            } finally {
                generateBtn.disabled = false;
                loader.classList.add('hidden');
            }
        }

        function buildFinalPrompt(dci, indication, evidence) {
            let template = JSON.parse(JSON.stringify(finalPromptTemplate));
            const today = new Date();
            const formattedDate = `${today.getDate().toString().padStart(2, '0')}/${(today.getMonth() + 1).toString().padStart(2, '0')}/${today.getFullYear()}`;
            const comparator = evidence.section4_data.comparator;

            // --- Relleno global de placeholders ---
            let templateString = JSON.stringify(template);
            templateString = templateString.replace(/\[DCI\]/g, dci)
                                       .replace(/\[INDICATION\]/g, indication)
                                       .replace(/\[COMPARATOR\]/g, comparator)
                                       .replace(/\[Fecha Actual\]/g, formattedDate);
            template = JSON.parse(templateString);

            // --- Relleno específico por sección ---
            let sec1 = template.report_content.sections.find(s => s.section_number === "1").data;
            sec1.find(d => d.key.includes("Código ATC")).value = evidence.section1_data.atc_code;
            sec1.find(d => d.key.includes("Forma farmacéutica (CNMB)")).value = evidence.section1_data.pharma_form_cnmb;
            sec1.find(d => d.key.includes("Formas farmacéuticas (ARCSA)")).value = evidence.section1_data.pharma_form_arcsa;
            sec1.find(d => d.key.includes("Concentración")).value = evidence.section1_data.concentration;
            sec1.find(d => d.key.includes("Vía de administración")).value = evidence.section1_data.admin_route;
            sec1.find(d => d.key.includes("Presentación comercial")).value = evidence.section1_data.commercial_presentation;
            sec1.find(d => d.key.includes("Información sanitaria")).value = evidence.section1_data.sanitary_info;

            let sec2 = template.report_content.sections.find(s => s.section_number === "2").data;
            sec2.find(d => d.key.includes("Mecanismo de acción")).value = evidence.section2_data.mechanism_of_action;
            sec2.find(d => d.key.includes("Pauta de dosificación")).value = evidence.section2_data.dosage_guideline;
            sec2.find(d => d.key.includes("Alternativas terapéuticas disponibles")).value = evidence.section2_data.alternatives_cnmb;
            sec2.find(d => d.key.includes("Alternativas terapéuticas no presentes")).value = evidence.section2_data.alternatives_not_cnmb;

            let sec3 = template.report_content.sections.find(s => s.section_number === "3");
            sec3.policies.rows = evidence.section3_data.policies.map(p => [p.country_agency, p.indication, p.date]);
            sec3.approvals.rows = evidence.section3_data.approvals.map(a => [a.agency, a.indication, a.type]);
            
            let sec5 = template.report_content.sections.find(s => s.section_number === "5");
            sec5.evidence_summary.find(e => e.key.includes("Eficacia")).value = evidence.section5_data.efficacy_nma_ref;
            sec5.evidence_summary.find(e => e.key.includes("Hallazgos de Eficacia")).value = evidence.section5_data.efficacy_nma_findings;
            sec5.grade_tables = evidence.section5_data.grade_tables_html;
            let safetyTable = sec5.safety_summary_table.data;
            safetyTable.find(d => d.key.includes("Referencia Clave")).value = evidence.section5_data.safety_nma_ref;
            safetyTable.find(d => d.key.includes("Frecuencia y Severidad")).value = evidence.section5_data.safety_frequency_severity;
            safetyTable.find(d => d.key.includes("Detalle")).value = evidence.section5_data.safety_details;
            safetyTable.find(d => d.key.includes("Alertas")).value = evidence.section5_data.safety_alerts;
            safetyTable.find(d => d.key.includes("Más seguro")).value = evidence.section5_data.is_safer_justification;

            let sec6 = template.report_content.sections.find(s => s.section_number === "6");
            sec6.cost_table.rows = evidence.section6_data.cost_table_rows.map(r => [r.parameter, r.intervention_value, r.comparator_value]);
            sec6.cost_analysis.value = evidence.section6_data.cost_analysis_justification;
            sec6.pharmacoeconomic_summary.value = evidence.section6_data.pharmacoeconomic_summary;

            let sec7 = template.report_content.sections.find(s => s.section_number === "7");
            sec7.convenience_table.rows = evidence.section7_data.convenience_rows.map(r => [r.parameter, r.response, r.justification]);

            template.report_content.sections.find(s => s.section_number === "10").items = evidence.section10_data.references;
            
            let matrix = template.report_content.sections.find(s => s.section_number === "MATRIZ");
            const matrizData = evidence.matriz_data;
            matrix.parameters.forEach(param => {
                if (param.question.includes("calidad de la evidencia")) param.result = matrizData.evidence_quality;
                if (param.question.includes("fase de investigación")) param.result = matrizData.research_phase;
                if (param.question.includes("esencial por la OMS")) param.result = matrizData.who_essential;
                if (param.question.includes("mejora el desenlace")) param.result = matrizData.improves_outcome;
                if (param.question.includes("eficacia es superior")) param.result = matrizData.efficacy_comparison;
                if (param.question.includes("mejora la calidad de vida")) param.result = matrizData.improves_qol;
                if (param.question.includes("reacciones adversas letales")) param.result = matrizData.lethal_adverse_reactions;
                if (param.question.includes("más seguro que las alternativas")) param.result = matrizData.is_safer;
                if (param.question.includes("alertas sanitarias")) param.result = matrizData.has_safety_alerts;
                if (param.question.includes("prevalencia >5%")) param.result = matrizData.prevalence_over_5;
                if (param.question.includes("alternativa terapéutica dentro del CNMB")) param.result = matrizData.is_cnmb_alternative;
                if (param.question.includes("mejora la adherencia")) param.result = matrizData.improves_adherence;
                if (param.question.includes("costo del tratamiento")) param.result = matrizData.cost_comparison;
            });

            return template;
        }

        generateBtn.addEventListener('click', handleGenerateClick);
        
        copyBtn.addEventListener('click', () => { 
            resultTextarea.select(); 
            document.execCommand('copy'); 
            showStatus('¡Prompt JSON copiado al portapapeles!', true);
        });

        downloadBtn.addEventListener('click', () => { 
            const dciForFile = dciInput.value.trim().toLowerCase().replace(/\s+/g, '_') || 'prompt'; 
            const blob = new Blob([resultTextarea.value], { type: 'application/json' }); 
            const a = document.createElement('a'); 
            a.href = URL.createObjectURL(blob); 
            a.download = `prompt_${dciForFile}.json`; 
            document.body.appendChild(a); 
            a.click(); 
            document.body.removeChild(a); 
            showStatus('Archivo JSON de prompt descargado.', true);
        });
    </script>
</body>
</html>
